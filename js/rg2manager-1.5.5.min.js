<<<<<<< HEAD:js/rg2manager-1.5.4.min.js
// Version 1.5.4 2019-05-05T12:59:47+0300;

!function(){function a(a){this.user=new rg2.User(a),this.newMap=new rg2.Map,this.georefsystems=new rg2.Georefs,this.eventName=null,this.eventDate=null,this.eventLevel=null,this.mapIndex=rg2.config.INVALID_MAP_ID,this.club=null,this.comments=null,this.format=rg2.config.FORMAT_NORMAL,this.newcontrols=new rg2.Controls,this.courses=[],this.mapping=[],this.mapLoaded=!1,this.coursesGeoreferenced=!1,this.controlsAdjusted=!1,this.drawingCourses=!1,this.drawnCourse={},this.results=[],this.variants=[],this.resultCourses=[],this.mapWidth=0,this.mapHeight=0,this.mapFile=void 0,this.resultsOrCourseFile=void 0,this.resultsFileFormat="",this.encodings=["UTF-8","ISO-8859-1","windows-1251"],this.errorCount=[],this.encodingIndex=0,this.useThisEncoding=!1,this.backgroundLocked=!1,this.sortResults=!1,this.handle={x:null,y:null},this.maps=[],this.localworldfile=new rg2.Worldfile(0),this.worldfile=new rg2.Worldfile(0),this.georefmap=L.map("rg2-world-file-map"),this.initialiseMap(),this.initialiseUI()}a.prototype={Constructor:a,initialiseUI:function(){var a;a=this,$("#btn-login").button(),$("#rg2-manage-courses").hide(),$("#rg2-manage-results").hide(),$("#chk-read-only").prop("checked",!1),$("#rg2-manager-login-form").submit(function(){var b;return b=a.user.setDetails($("#rg2-user-name").val().toLowerCase(),$("#rg2-password").val()),b?a.logIn():rg2.utils.showWarningDialog("Login failed","Please enter user name and password of at least five characters"),!1})},initialiseMap:function(){L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(this.georefmap)},logIn:function(){var a,b,c;return a=rg2Config.json_url+"?type=login",b=JSON.stringify(this.user.encodeUser()),c=this,$.ajax({type:"POST",dataType:"json",data:b,url:a,cache:!1,success:function(a){c.user.y=a.keksi,a.ok?c.enableEventEdit():rg2.utils.showWarningDialog("Login failed","Login failed. Please try again.")},error:function(){rg2.utils.showWarningDialog("Login failed","User name or password incorrect. Please try again.")}}),!1},setButtons:function(){var a;a=this,$("#btn-create-event").button().click(function(){a.confirmCreateEvent()}).button("enable"),$("#btn-update-event").button().click(function(){a.confirmUpdateEvent()}).button("disable"),$("#btn-delete-route").button().click(function(){a.confirmDeleteRoute()}).button("disable"),$("#btn-delete-event").button().click(function(){a.confirmDeleteEvent()}).button("disable"),$("#btn-add-map").button().click(function(){a.confirmAddMap()}).button("disable"),$("#btn-draw-courses").button().click(function(){a.startDrawingCourses()}),$("#rg2-load-georef-file").val("").button().change(function(b){a.readGeorefFile(b)}),$("#rg2-load-map-file").val("").button().change(function(b){a.validateMapUpload(this.files[0]),a.readMapFile(b)}),$("#rg2-load-results-file").val("").button().click(function(b){a.mapLoaded||(rg2.utils.showWarningDialog("No map loaded","Please load a map file before adding results."),b.preventDefault())}).change(function(b){a.resultsOrCourseFile=b.target.files[0],a.initialiseEncodings(),a.readResults()}),$("#btn-move-map-and-controls").click(function(b){a.toggleMoveAll(b.target.checked)}),$("#btn-no-results").click(function(b){a.toggleResultsRequired(b.target.checked)}),$("#btn-sort-results").click(function(b){a.toggleSortResults(b.target.checked)}),$("#rg2-load-course-file").val("").button().click(function(b){a.mapLoaded||(rg2.utils.showWarningDialog("No map loaded","Please load a map file before adding courses."),b.preventDefault())}).change(function(b){a.readCourses(b)})},validateMapUpload:function(a){var b,c,d;b=new FileReader,b.onload=function(b){c=new Image,c.src=b.target.result,c.onload=function(){var b;d=Math.round(a.size/1024/1024),b="The uploaded map file is "+d+"MB ("+this.width,b+=" x "+this.height+"). It is recommended that you only use maps under",b+=" "+rg2.config.FILE_SIZE_WARNING+"MB. Please see the ",b+="<a href='https://github.com/Maprunner/rg2/wiki/Map-files'>RG2 wiki</a> for ",b+="guidance on how to create map files.",d>rg2.config.FILE_SIZE_WARNING&&rg2.utils.showWarningDialog("Oversized map upload",b)}},b.readAsDataURL(a)},initialiseEncodings:function(){this.encodingIndex=0,this.errorCount=[],this.useThisEncoding=!1},enableEventEdit:function(){var a=this;rg2.managerUI.setUIVisibility(),this.getMaps(),this.setButtons(),rg2.managerUI.createEventLevelDropdown("rg2-event-level"),rg2.managerUI.createEventLevelDropdown("rg2-event-level-edit"),rg2.managerUI.createGeorefDropdown(this.georefsystems),rg2.managerUI.createEventEditDropdown(),$("#rg2-event-level").change(function(){a.eventLevel=$("#rg2-event-level").val()}),$("#rg2-map-selected").change(function(){a.mapIndex=parseInt($("#rg2-map-selected").val(),10),a.mapIndex!==rg2.config.INVALID_MAP_ID?($("#rg2-manager-map-select").removeClass("required"),rg2.loadNewMap(rg2Config.maps_url+"/"+a.maps[a.mapIndex].mapfilename)):($("#rg2-manager-map-select").addClass("required"),a.mapLoaded=!1,a.mapWidth=0,a.mapHeight=0)}),$("#rg2-event-date").datepicker({dateFormat:"yy-mm-dd",showWeek:!0,firstDay:1,onSelect:function(b){a.setDate(b)}}),$("#rg2-event-name").on("change",function(){a.setEventName()}),$("#rg2-map-name").on("change",function(){a.setMapName()}),$("#rg2-map-copyright").on("change",function(){a.setMapCopyright()}),$("#rg2-club-name").on("change",function(){a.setClub()}),$("#rg2-new-course-name").on("change",function(){a.setCourseName()}),$("#rg2-manager-event-select").change(function(){rg2.managerUI.setEvent(parseInt($("#rg2-event-selected").val(),10))}),$("#rg2-georef-type").change(function(){a.setGeoref($("#rg2-georef-selected").val())}),$("#rg2-info-panel").tabs("option","active",rg2.config.TAB_CREATE)},getMaps:function(){var a,b;b=this,$.getJSON(rg2Config.json_url,{type:"maps",cache:!1}).done(function(c){for(b.maps.length=0,console.log("Maps: "+c.data.maps.length),a=0;a<c.data.maps.length;a+=1)b.maps.push(new rg2.Map(c.data.maps[a]));rg2.managerUI.createMapDropdown(b.maps),$("#btn-toggle-controls").parent().show()}).fail(function(){rg2.utils.showWarningDialog("Map request failed","Error getting map list.")})},setGeoref:function(a){null!==a&&this.convertWorldFile(a)},eventListLoaded:function(){rg2.managerUI.createEventEditDropdown()},eventFinishedLoading:function(){var a;a=parseInt($("#rg2-event-selected").val(),10),rg2.managerUI.eventFinishedLoading(rg2.events.getEventInfo(a))},startDrawingCourses:function(){this.mapLoaded?(this.drawingCourses=!0,this.courses.length=0,this.newcontrols.deleteAllControls(),this.drawnCourse.name="Course",this.drawnCourse.x=[],this.drawnCourse.y=[],this.drawnCourse.codes=[],this.drawnCourse.courseid=0,$("#rg2-new-course-name").val("Course"),$("#rg2-draw-courses").show()):rg2.utils.showWarningDialog("No map selected","Please load a map before drawing courses")},displayCourseAllocations:function(){var a,b;if(this.courses.length&&this.resultCourses.length){for(b="<div id='rg2-course-allocations'><table><thead><tr><th>Results</th><th>Course</th></tr></thead><tbody>",a=0;a<this.resultCourses.length;a+=1)b+="<tr><td>"+this.resultCourses[a].course+"</td><td>"+this.createCourseDropdown(this.resultCourses[a].course,a)+"</td></tr>";b+="</tbody></table></div>",$("#rg2-course-allocations").empty().append(b)}},createResultCourseMapping:function(){var a;if(this.format===rg2.config.FORMAT_NO_RESULTS)for(this.resultCourses.length=0,a=0;a<this.courses.length;a+=1)this.resultCourses.push({courseid:this.courses[a].courseid,course:this.courses[a].name})},validateData:function(){return this.eventName?this.mapIndex===rg2.config.INVALID_MAP_ID?"No map selected.":this.club?this.eventDate?this.eventLevel?this.format?0!==this.courses.length||this.drawingCourses?0===this.results.length&&this.format!==rg2.config.FORMAT_NO_RESULTS?"No results information. Check your results file.":this.controlsAdjusted?"OK":"Controls have not been adjusted on the map.":"No course information. Check your course XML file.":"Event format is not valid.":"Event level is not valid.":"Date is not valid.":"Club name is not valid.":"Event name is not valid."},confirmCreateEvent:function(){var a,b;return a=this.validateData(),"OK"!==a?void rg2.utils.showWarningDialog("Event set-up incomplete",a+" Please enter all necessary information and make sure controls are aligned before creating the event."):(b={},b.selector="<div id='event-create-dialog'>Are you sure you want to create this event?</div>",b.title="Confirm event creation",b.classes="rg2-confirm-create-event-dialog",b.doText="Create event",b.onDo=this.doCreateEvent.bind(this),b.onCancel=rg2.managerUI.doCancelCreateEvent.bind(this),void rg2.utils.createModalDialog(b))},doCreateEvent:function(){var a,b;$("#event-create-dialog").dialog("destroy"),a=this,b=this.generateNewEventData(),$("#rg2-load-progress-label").text("Creating event"),$("#rg2-load-progress").show(),$.ajax({data:b,type:"POST",url:rg2Config.json_url+"?type=createevent",dataType:"json",success:function(b){a.user.y=b.keksi,b.ok?(rg2.utils.showWarningDialog("Event created",a.eventName+" has been added with id "+b.newid+"."),window.open(rg2Config.json_url.replace("rg2api.php","index.php")+"#"+b.newid),rg2.getEvents(),rg2.managerUI.setEvent()):rg2.utils.showWarningDialog("Save failed",b.status_msg+" Failed to create event. Please try again.")},error:function(){rg2.utils.showWarningDialog("Save failed"," Failed to create event.")},complete:function(){$("#rg2-load-progress-label").text(""),$("#rg2-load-progress").hide()}})},generateNewEventData:function(){var a,b,c,d;for(a={},a.name=this.eventName,a.mapid=this.maps[this.mapIndex].mapid,a.eventdate=this.eventDate,b=$("#rg2-event-comments").val(),b===rg2.t(rg2.config.DEFAULT_EVENT_COMMENT)?a.comments="":a.comments=b,a.locked=$("#chk-read-only").prop("checked"),a.club=this.club,a.format=this.format,$("#btn-score-event").prop("checked")&&(a.format=rg2.config.FORMAT_SCORE_EVENT),a.level=this.eventLevel,this.drawingCourses&&(this.courses.push(this.drawnCourse),this.createResultCourseMapping()),this.setControlLocations(),this.mapResultsToCourses(),this.renumberResults(),a.format===rg2.config.FORMAT_SCORE_EVENT&&(this.extractVariants(),a.variants=this.variants.slice(0)),a.courses=this.courses.slice(0),this.sortResults?a.results=this.results.slice(0).sort(this.sortResultItems):a.results=this.results.slice(0),d=0;d<a.results.length;d+=1)delete a.results[d].codes,delete a.results[d].chipid,delete a.results[d].club;return c=this.user.encodeUser(),a.x=c.x,a.y=c.y,JSON.stringify(a)},hasZeroTime:function(a){return 0===a||"0"===a||"0:00"===a||"00:00"===a},sortResultItems:function(a,b){return a.courseid!==b.courseid?a.courseid-b.courseid:""!==a.position&&""!==b.position?a.position-b.position:""===a.position&&""!==b.position?1:""!==a.position&&""===b.position?-1:this.rg2.Manager.prototype.hasZeroTime(a.time)&&this.rg2.Manager.prototype.hasZeroTime(b.time)?a.name-b.name:a.time-b.time},renumberResults:function(){var a,b,c;for(b=[],a=0;a<this.results.length;a+=1)c=this.getCourseIDForResult(this.results[a].course),c!==rg2.config.DO_NOT_SAVE_COURSE&&(this.results[a].courseid=c,this.results[a].course=this.getCourseName(c),this.results[a].variantid="",b.push(this.results[a]));this.results=b},getCourseName:function(a){var b;for(b=0;b<this.courses.length;b+=1)if(this.courses[b].courseid===a)return this.courses[b].name;return 0},mapResultsToCourses:function(){var a,b,c,d,e;for(d=[],e=1,a=0;a<this.resultCourses.length;a+=1)this.drawingCourses?c=0:(b="#rg2-alloc-"+a,c=parseInt($(b).val(),10)),c!==rg2.config.DO_NOT_SAVE_COURSE&&(0===this.courses[c].courseid?(this.courses[c].courseid=e,d.push(this.courses[c]),this.resultCourses[a].courseid=e,e+=1):this.resultCourses[a].courseid=this.courses[c].courseid);this.courses=d},createCourseDropdown:function(a,b){var c,d,e,f;for(e=-1,c=0;c<this.courses.length;c+=1)if(this.courses[c].name===a){e=c;break}if(e===-1&&this.mapping.length>0)for(c=0;c<this.mapping.length;c+=1)if(this.mapping[c].className===a){for(d=0;d<this.courses.length;d+=1)if(this.courses[d].name===this.mapping[c].course){e=d;break}break}for(f="<select id='rg2-alloc-"+b+"'><option value="+rg2.config.DO_NOT_SAVE_COURSE,e===-1&&(f+=" selected"),f+=">Do not save</option>",c=0;c<this.courses.length;c+=1)f+="<option value="+c,e===c&&(f+=" selected"),f+=">"+this.courses[c].name+"</option>";return f+="</select>"},extractVariants:function(){var a,b,c,d;for(this.variants.length=0,a=0;a<this.results.length;a+=1){for(c=this.results[a].codes,b=0;b<this.courses.length;b+=1)if(this.courses[b].courseid===this.results[a].courseid){d=this.courses[b];break}c.unshift(d.codes[0]),c.push(d.codes[d.codes.length-1]),this.results[a].variantid=this.getVariantID(this.results[a].codes,this.results[a].courseid)}},getVariantID:function(a,b){var c,d,e,f,g,h,i;for(f=[],g=[],i=0,c=0;c<this.variants.length;c+=1)if(this.variants[c].codes.length===a.length){for(h=!0,d=0;d<a.length;d+=1)if(this.variants[c].codes[d]!==a[d]){h=!1;break}if(h){i=c+1;break}}if(0===i){for(i=this.variants.length+1,c=0;c<a.length;c+=1)e=this.getControlXY(a[c]),f.push(e.x),g.push(e.y);this.variants.push({x:f,y:g,id:i,courseid:b,name:"Variant "+i,codes:a})}return i},getCourseIDForResult:function(a){var b;for(b=0;b<this.resultCourses.length;b+=1)if(this.resultCourses[b].course===a)return this.resultCourses[b].courseid;return 0},setControlLocations:function(){var a,b,c;for(a=0;a<this.courses.length;a+=1)for(b=0;b<this.courses[a].codes.length;b+=1)c=this.getControlXY(this.courses[a].codes[b]),this.courses[a].x[b]=c.x,this.courses[a].y[b]=c.y},getControlXY:function(a){var b,c;for(c={},c.x=0,c.y=0,b=0;b<this.newcontrols.controls.length;b+=1)if(this.newcontrols.controls[b].code===a)return c.x=Math.round(this.newcontrols.controls[b].x),c.y=Math.round(this.newcontrols.controls[b].y),c;return c},confirmUpdateEvent:function(){var a;a={},a.selector="<div id='event-update-dialog'>Are you sure you want to update this event?</div>",a.title="Confirm event update",a.classes="rg2-confirm-update-dialog",a.doText="Update event",a.onDo=this.doUpdateEvent.bind(this),a.onCancel=rg2.managerUI.doCancelUpdateEvent.bind(this),rg2.utils.createModalDialog(a)},doUpdateEvent:function(){var a,b,c,d,e,f;$("#event-update-dialog").dialog("destroy"),a=$("#rg2-event-selected").val(),b=rg2Config.json_url+"?type=editevent&id="+a,c={},c.comments=$("#rg2-edit-event-comments").val(),c.locked=$("#chk-edit-read-only").prop("checked"),c.name=$("#rg2-event-name-edit").val(),c.type=$("#rg2-event-level-edit").val(),c.eventdate=$("#rg2-event-date-edit").val(),c.club=$("#rg2-club-name-edit").val(),f=this.user.encodeUser(),c.x=f.x,c.y=f.y,d=JSON.stringify(c),e=this,$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(b){e.user.y=b.keksi,b.ok?(rg2.utils.showWarningDialog("Event updated","Event "+a+" has been updated."),rg2.events.setActiveEventID(null),rg2.ui.setTitleBar(),rg2.getEvents(),rg2.managerUI.setEvent()):rg2.utils.showWarningDialog("Update failed",b.status_msg+". Event update failed. Please try again.")},error:function(a,b){rg2.utils.showWarningDialog("Update failed",b+". Event update failed.")}})},confirmDeleteRoute:function(){var a;a={},a.selector="<div id='route-delete-dialog'>This route will be permanently deleted. Are you sure?</div>",a.title="Confirm route delete",a.classes="rg2-confirm-route-delete-dialog",a.doText="Delete route",a.onDo=this.doDeleteRoute.bind(this),a.onCancel=rg2.managerUI.doCancelDeleteRoute.bind(this),rg2.utils.createModalDialog(a)},doDeleteRoute:function(){var a,b,c,d,e;$("#route-delete-dialog").dialog("destroy"),a=$("#rg2-event-selected").val(),c=$("#rg2-route-selected").val(),b=rg2Config.json_url+"?type=deleteroute&id="+a+"&routeid="+c,d=JSON.stringify(this.user.encodeUser()),e=this,$.ajax({data:d,type:"POST",url:b,dataType:"json",success:function(b){e.user.y=b.keksi,b.ok?(rg2.utils.showWarningDialog("Route deleted","Route "+c+" has been deleted."),rg2.results.deleteResult(parseInt(c,10)),rg2.managerUI.createRouteDeleteDropdown(a)):rg2.utils.showWarningDialog("Delete failed",b.status_msg+". Delete failed. Please try again.")},error:function(a,b){rg2.utils.showWarningDialog("Delete failed",b+". Delete failed.")}})},confirmDeleteEvent:function(){var a;a={},a.selector="<div id='event-delete-dialog'>This event will be deleted. Are you sure?</div>",a.title="Confirm event delete",a.classes="rg2-confirm-delete-event-dialog",a.doText="Delete event",a.onDo=this.doDeleteEvent.bind(this),a.onCancel=rg2.managerUI.doCancelDeleteEvent.bind(this),rg2.utils.createModalDialog(a)},doDeleteEvent:function(){var a,b,c,d;$("#event-delete-dialog").dialog("destroy"),a=$("#rg2-event-selected").val(),b=rg2Config.json_url+"?type=deleteevent&id="+a,c=JSON.stringify(this.user.encodeUser()),d=this,$.ajax({data:c,type:"POST",url:b,dataType:"json",success:function(b){d.user.y=b.keksi,b.ok?(rg2.utils.showWarningDialog("Event deleted","Event "+a+" has been deleted."),rg2.getEvents(),rg2.managerUI.setEvent(),$("#rg2-event-selected").empty()):rg2.utils.showWarningDialog("Delete failed",b.status_msg+". Event delete failed. Please try again.")},error:function(a,b){rg2.utils.showWarningDialog("Delete failed",b+". Delete failed.")}})},readResults:function(){var a,b,c;b=new FileReader,c=this,b.onerror=function(){rg2.utils.showWarningDialog("Results file error","The selected results file could not be read.")},b.onload=function(a){c.checkResultsFileEncoding(a)},a=this.resultsOrCourseFile.name.substr(-3,3).toUpperCase(),"XML"===a||"CSV"===a?(this.resultsFileFormat=a,b.readAsText(this.resultsOrCourseFile,this.encodings[this.encodingIndex])):rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")},checkResultsFileEncoding:function(a){var b,c,d;if(b=this.testForInvalidCharacters(a.target.result),0===b||this.useThisEncoding)return void this.processResultFile(a);if(this.errorCount[this.encodingIndex]=b,this.encodingIndex+=1,this.encodingIndex===this.encodings.length){for(c=99999,d=0;d<this.encodings.length;d+=1)c>this.errorCount[d]&&(this.encodingIndex=d,c=this.errorCount[d]);this.useThisEncoding=!0}this.readResults()},processResultFile:function(a){var b=new rg2.ResultParser(a,this.resultsFileFormat);this.results=b.results,this.resultCourses=b.resultCourses,b.valid?$("#rg2-select-results-file").removeClass("required"):$("#rg2-select-results-file").addClass("required"),rg2.managerUI.displayResultInfo(this.getResultInfoAsHTML()),this.displayCourseAllocations()},readCourses:function(a){var b,c;b=new FileReader,b.onerror=function(){rg2.utils.showWarningDialog("Course file error","The selected course file could not be read.")},c=this,b.onload=function(a){c.processCourseFile(a)},b.readAsText(a.target.files[0])},processCourseFile:function(a){var b;this.coursesGeoreferenced=!1,this.backgroundLocked=!1,$("#btn-move-map-and-controls").prop("checked",!1),this.handle={x:null,y:null},this.newcontrols.deleteAllControls(),b=new rg2.CourseParser(a,this.worldfile,this.localworldfile),this.courses=b.courses,this.newcontrols=b.newcontrols,this.mapping=b.mapping,this.coursesGeoreferenced=b.georeferenced,rg2.managerUI.displayCourseInfo(this.getCourseInfoAsHTML()),this.createResultCourseMapping(),this.displayCourseAllocations(),this.fitControlsToMap(),rg2.redraw(!1)},getCourseInfoAsHTML:function(){var a,b;if(this.courses.length){for(a="<table><thead><tr><th>Course</th><th>Name</th><th>Controls</th></tr></thead><tbody>",b=0;b<this.courses.length;b+=1)a+="<tr><td>"+(b+1)+"</td><td>"+this.courses[b].name+"</td><td>"+(this.courses[b].codes.length-2)+"</td></tr>";a+="</tbody></table>"}else a="";return a},getResultInfoAsHTML:function(){var a,b,c,d;if(this.results.length){for(a="<table><thead><tr><th>Course</th><th>Winner</th><th>Time</th><th>Runners</th></tr></thead><tbody>",c=0,d=null,b=0;b<this.results.length;b+=1)this.results[b].course!==d&&(null!==d&&(a+="<td>"+c+"</td></tr>",c=0),a+="<tr><td>"+this.results[b].course+"</td><td>"+this.results[b].name+"</td><td>"+this.results[b].time+"</td>",d=this.results[b].course),c+=1;a+="<td>"+c+"</td></tr></tbody></table>"}else a="No valid results found.";return a},testForInvalidCharacters:function(a){var b,c;for(c=0,b=0;b<a.length;b+=1)65533===a.charCodeAt(b)&&(c+=1);return console.log("Encoding: "+this.encodings[this.encodingIndex]+", Invalid characters: "+c),c},readMapFile:function(a){var b,c,d;b=new FileReader,c=this,b.onload=function(a){c.processMap(a)},d=a.target.files[0].name.substr(-3,3).toUpperCase(),"JPG"===d||"GIF"===d?(this.mapFile=a.target.files[0],b.readAsDataURL(a.target.files[0])):rg2.utils.showWarningDialog("File type error",a.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")},mapLoadCallback:function(){var a;this.mapLoaded=!0,this.mapIndex!==rg2.config.INVALID_MAP_ID&&(this.localworldfile=this.maps[this.mapIndex].localworldfile,this.worldfile=this.maps[this.mapIndex].worldfile),a=rg2.getMapSize(),this.mapWidth=a.width,this.mapHeight=a.height,this.fitControlsToMap(),rg2.redraw(!1)},processMap:function(a){var b;rg2.loadNewMap(a.target.result),$("#rg2-select-map-file").removeClass("required"),this.mapLoaded=!0,b=rg2.getMapSize(),this.mapWidth=b.width,this.mapHeight=b.height,this.fitControlsToMap(),rg2.redraw(!1),$("#btn-add-map").button("enable")},fitControlsToMap:function(){var a,b,c,d;if(b=!1,this.mapLoaded&&this.newcontrols.controls.length>0){if(c=this.getBoundingBox(),this.coursesGeoreferenced&&(c.maxX<0||c.minX>this.mapWidth||c.minY>this.mapHeight||c.maxY<0?rg2.utils.showWarningDialog("Course file problem","Your course file does not match the map co-ordinates. Please check you have selected the correct file."):b=!0),b)this.backgroundLocked=!0,this.controlsAdjusted=!0,$("#btn-move-map-and-controls").prop("checked",!0);else for(d=.8,a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].x=(this.newcontrols.controls[a].x-c.minX)*(this.mapWidth/c.xRange)*d+this.mapWidth*(1-d)*.5,this.newcontrols.controls[a].y=this.mapHeight-(this.newcontrols.controls[a].y-c.minY)*(this.mapHeight/c.yRange)*d-this.mapHeight*(1-d)*.5;this.copyXYToOldXY(),this.newcontrols.displayAllControls()}},getBoundingBox:function(){var a,b;for(a={},a.minX=this.newcontrols.controls[0].x,a.maxX=this.newcontrols.controls[0].x,a.minY=this.newcontrols.controls[0].y,a.maxY=this.newcontrols.controls[0].y,b=1;b<this.newcontrols.controls.length;b+=1)a.maxX=Math.max(a.maxX,this.newcontrols.controls[b].x),a.maxY=Math.max(a.maxY,this.newcontrols.controls[b].y),a.minX=Math.min(a.minX,this.newcontrols.controls[b].x),a.minY=Math.min(a.minY,this.newcontrols.controls[b].y);return a.xRange=a.maxX-a.minX,a.yRange=a.maxY-a.minY,a},copyXYToOldXY:function(){var a;for(a=0;a<this.newcontrols.controls.length;a+=1)this.newcontrols.controls[a].oldX=this.newcontrols.controls[a].x,this.newcontrols.controls[a].oldY=this.newcontrols.controls[a].y},setClub:function(){this.club=$("#rg2-club-name").val()},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").removeClass("required"):$("#rg2-select-event-name").addClass("required")},setCourseName:function(){var a=$("#rg2-new-course-name").val();a&&(this.drawnCourse.name=a)},setMapName:function(){this.newMap.name=$("#rg2-map-name").val(),this.newMap.name?$("#rg2-select-map-name").removeClass("required"):$("#rg2-select-map-name").addClass("required")},setMapCopyright:function(){this.newMap.copyright=$("#rg2-map-copyright").val()},setDate:function(a){this.eventDate=a,this.eventDate?$("#rg2-select-event-date").removeClass("required"):$("#rg2-select-event-date").addClass("required")},drawControls:function(){if(this.mapLoaded&&this.newcontrols.controls.length>0){this.newcontrols.drawControls(!0);var a=rg2.getOverprintDetails();null!==this.handle.x&&(rg2.ctx.lineWidth=a.overprintWidth,rg2.ctx.strokeStyle=rg2.config.HANDLE_COLOUR,rg2.ctx.fillStyle=rg2.config.HANDLE_COLOUR,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handle.x,this.handle.y,rg2.config.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handle.x,this.handle.y,2*rg2.config.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke())}},adjustControls:function(a,b,c){var d,e,f,g,h,i,j;if(this.backgroundLocked||c===rg2.config.RIGHT_CLICK)rg2.ctx.translate(b.x-a.x,b.y-a.y);else if(this.controlsAdjusted=!0,null!==this.handle.x){if(i=(b.x-this.handle.x)/(a.x-this.handle.x),j=(b.y-this.handle.y)/(a.y-this.handle.y),isFinite(i)&&isFinite(j))for(d=0;d<this.newcontrols.controls.length;d+=1)e=this.newcontrols.controls[d].oldX-this.handle.x,f=this.newcontrols.controls[d].oldY-this.handle.y,this.newcontrols.controls[d].x=e*i+this.handle.x,this.newcontrols.controls[d].y=f*j+this.handle.y}else for(g=b.x-a.x,h=b.y-a.y,d=0;d<this.newcontrols.controls.length;d+=1)this.newcontrols.controls[d].x=this.newcontrols.controls[d].oldX+g,this.newcontrols.controls[d].y=this.newcontrols.controls[d].oldY+h},dragEnded:function(){this.mapLoaded&&this.newcontrols.controls.length>0&&this.copyXYToOldXY()},mouseUp:function(a,b){return this.drawingCourses?(this.addNewControl(a,b),void(this.controlsAdjusted=!0)):void(this.mapLoaded&&this.newcontrols.controls.length>0&&(null===this.handle.x?this.handle={x:a,y:b}:this.handle={x:null,y:null}))},addNewControl:function(a,b){var c;c=0===this.newcontrols.controls.length?"S"+(this.newcontrols.controls.length+1):"X"+(this.newcontrols.controls.length+1),this.newcontrols.addControl(c,a,b),this.newcontrols.controls[this.newcontrols.controls.length-1].oldX=a,this.newcontrols.controls[this.newcontrols.controls.length-1].oldY=b,this.newcontrols.displayAllControls(),this.drawnCourse.codes.push(c),this.drawnCourse.x.push(a),this.drawnCourse.y.push(b)},toggleMoveAll:function(a){this.backgroundLocked=a},toggleSortResults:function(a){this.sortResults=a},toggleResultsRequired:function(a){a?(this.format=rg2.config.FORMAT_NO_RESULTS,this.createResultCourseMapping()):this.format=rg2.config.FORMAT_NORMAL},confirmAddMap:function(){var a;a={},a.selector="<div id='add-map-dialog'>Are you sure you want to add this map?</div>",a.title="Confirm new map",a.classes="rg2-confirm-add-map-dialog",a.doText="Add map",a.onDo=this.doUploadMapFile.bind(this),a.onCancel=rg2.managerUI.doCancelAddMap.bind(this),rg2.utils.createModalDialog(a)},doUploadMapFile:function(){var a,b,c,d;$("#add-map-dialog").dialog("destroy"),a=rg2Config.json_url+"?type=uploadmapfile",b=this.user.encodeUser(),c=this,d=new FormData,d.append(this.mapFile.name,this.mapFile),d.append("name",this.mapFile.name),d.append("x",b.x),d.append("y",b.y),$("#rg2-load-progress-label").text("Saving map"),$("#rg2-load-progress").show(),$.ajax({url:a,data:d,type:"POST",mimeType:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",success:function(a){c.user.y=a.keksi,a.ok?c.doAddMap():rg2.utils.showWarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b),rg2.utils.showWarningDialog("Upload failed","Failed to upload data to server.")},complete:function(){$("#rg2-load-progress-label").text(""),$("#rg2-load-progress").hide()}})},doAddMap:function(){var a,b,c,d,e;a=rg2Config.json_url+"?type=addmap",b={},this.newMap.localworldfile=this.localworldfile,b=this.newMap,c=this.user.encodeUser(),b.x=c.x,b.y=c.y,d=JSON.stringify(b),e=this,$.ajax({data:d,type:"POST",url:a,dataType:"json",success:function(a){e.user.y=a.keksi,a.ok?(rg2.utils.showWarningDialog("Map added",e.newMap.name+" has been added with id "+a.newid+"."),e.getMaps()):rg2.utils.showWarningDialog("Save failed",a.status_msg+". Failed to save map. Please try again.")},error:function(a,b){console.log(b)}})},readGeorefFile:function(a){var b,c;b=new FileReader,c=this;try{b.readAsText(a.target.files[0])}catch(a){return void rg2.utils.showWarningDialog("File read error","Failed to open selected world file.")}b.onerror=function(){rg2.utils.showWarningDialog("World file error","The selected world file could not be read.")},b.onload=function(a){var b,d;b=a.target.result,d=b.split(/[\r\n]+/g),delete c.localworldfile,c.localworldfile=new rg2.Worldfile({A:d[0],B:d[2],C:d[4],D:d[1],E:d[3],F:d[5]}),$("#rg2-georef-selected").val(c.georefsystems.getDefault()),c.convertWorldFile(c.georefsystems.getDefault())}},convertWorldFile:function(a){try{var b,c,d,e,f,g,h,i,j,k,l;if(c=rg2.getMapSize(),this.mapWidth=c.width,this.mapHeight=c.height,!this.localworldfile.valid||0===this.mapWidth||"none"===a)throw"Do not georeference";for(Proj4js.defs[a]=this.georefsystems.getParams(a),d=new Proj4js.Proj(a),e=new Proj4js.Proj("EPSG:4326"),h=[0,this.mapWidth,this.mapWidth,0],i=[0,this.mapHeight,0,this.mapHeight],f=[],g=[],b=0;b<4;b+=1)f[b]=this.localworldfile.getLon(h[b],i[b]),g[b]=this.localworldfile.getLat(h[b],i[b]);for(this.newMap.xpx.length=0,this.newMap.ypx.length=0,this.newMap.lat.length=0,this.newMap.lon.length=0,j=[],b=0;b<4;b+=1)k={},k.x=f[b],k.y=g[b],j.push(k),Proj4js.transform(d,e,j[b]),this.newMap.xpx.push(h[b]),this.newMap.ypx.push(i[b]),this.newMap.lat.push(j[b].y),this.newMap.lon.push(j[b].x);l={},l.C=j[0].x,l.F=j[0].y,l.A=(j[2].x-l.C)/h[2],l.B=(j[3].x-l.C)/i[3],l.D=(j[2].y-l.F)/h[2],l.E=(j[3].y-l.F)/i[3],delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(l),this.updateGeorefDisplay(),this.updateGeorefMap()}catch(a){return delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(0),this.updateGeorefDisplay(),void this.updateGeorefMap()}},updateGeorefDisplay:function(){var a,b;for(a=["A","B","C","D","E","F"],b=0;b<a.length;b+=1)$("#georef-"+a[b]).empty().text(a[b]+": "+this.newMap.worldfile[a[b]])},updateGeorefMap:function(){var a,b,c,d,e;a=this.newMap.lon,b=this.newMap.lat,d=[],e=[3,1,2,0],e.forEach(function(c){d.push([b[c],a[c]])}),c=L.polygon(d,{color:"red"}),c.addTo(this.georefmap),$("#rg2-world-file-map").show(),this.georefmap.invalidateSize(),this.georefmap.fitBounds(c.getBounds())}},rg2.Manager=a}(),function(){function a(a,b,c){return this.courses=[],this.courseClassMapping=[],this.newcontrols=new rg2.Controls,this.courses.length=0,this.courseClassMapping.length=0,this.fromCondes=!1,this.coursesGeoreferenced=!1,this.newcontrols.deleteAllControls(),this.localWorldfile=c,this.worldfile=b,this.processCoursesXML(a.target.result),{courses:this.courses,newcontrols:this.newcontrols,mapping:this.courseClassMapping,georeferenced:this.coursesGeoreferenced}}a.prototype={Constructor:a,processCoursesXML:function(a){var b,c,d;try{b=$.parseXML(a)}catch(a){return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file.")}if(d=b.getElementsByTagName("CourseData"),0===d.length)return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file. CourseData element missing.");switch(c=this.getVersion(b)){case"2.0.3":this.processIOFV2XMLCourses(b);break;case"3.0":this.processIOFV3XMLCourses(b);break;default:rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+c+" not supported.")}},getVersion:function(a){var b,c;return c="",b=a.getElementsByTagName("IOFVersion"),b.length>0&&(c=b[0].getAttribute("version")),""===c&&(b=a.getElementsByTagName("CourseData"),b.length>0&&(c=b[0].getAttribute("iofVersion").trim(),this.setCreator(b[0].getAttribute("creator").trim()))),c},setCreator:function(a){a.indexOf("Condes")>-1&&(this.fromCondes=!0)},processIOFV3XMLCourses:function(a){var b,c,d,e,f;for(b=a.getElementsByTagName("Control"),e={x:0,y:0},c=0;c<b.length;c+=1)"RaceCourseData"===b[c].parentNode.nodeName&&(d=b[c].getElementsByTagName("Id")[0].textContent,f=b[c].getElementsByTagName("Position"),this.localWorldfile.valid&&f.length>0?(e=this.getXYFromLatLng(f),this.coursesGeoreferenced=!0):e=this.getXYFromMapPosition(b[c].getElementsByTagName("MapPosition")),"CrossingPoint"!==b[c].getAttribute("type")&&this.newcontrols.addControl(d.trim(),e.x,e.y));b=a.getElementsByTagName("Course"),this.extractV3Courses(b),b=a.getElementsByTagName("ClassCourseAssignment"),
this.extractV3CourseClassMapping(b)},getXYFromLatLng:function(a){var b,c,d;return d={x:0,y:0},b=parseFloat(a[0].getAttribute("lat")),c=parseFloat(a[0].getAttribute("lng")),this.fromCondes?(d.x=this.localWorldfile.getX(c,b),d.y=this.localWorldfile.getY(c,b)):(d.x=this.worldfile.getX(c,b),d.y=this.worldfile.getY(c,b)),d},processIOFV2XMLCourses:function(a){var b,c,d;if(this.extractV2Controls(a.getElementsByTagName("StartPoint"),"StartPointCode"),this.extractV2Controls(a.getElementsByTagName("Control"),"ControlCode"),this.coursesGeoreferenced=this.extractV2Controls(a.getElementsByTagName("FinishPoint"),"FinishPointCode"),this.coursesGeoreferenced&&this.localWorldfile.valid)for(b=0;b<this.newcontrols.controls.length;b+=1)c=this.newcontrols.controls[b].x,d=this.newcontrols.controls[b].y,this.newcontrols.controls[b].x=this.localWorldfile.getX(c,d),this.newcontrols.controls[b].y=this.localWorldfile.getY(c,d);this.extractV2Courses(a.getElementsByTagName("Course"))},extractV2Courses:function(a){var b,c,d,e,f;for(b=0;b<a.length;b+=1)d=[],e=[],f=[],c=a[b].getElementsByTagName("CourseName")[0].textContent.trim(),d=this.extractCodesFromControlList(a[b],"ControlCode"),d.unshift(a[b].getElementsByTagName("StartPointCode")[0].textContent.trim()),d.push(a[b].getElementsByTagName("FinishPointCode")[0].textContent.trim()),this.courses.push({courseid:0,x:e,y:f,codes:d,name:c});$("#rg2-select-course-file").addClass("valid")},extractV3Courses:function(a){var b,c,d,e,f;for(b=0;b<a.length;b+=1)d=[],e=[],f=[],c=a[b].getElementsByTagName("Name")[0].textContent.trim(),d=this.extractCodesFromControlList(a[b],"Control"),this.courses.push({courseid:0,x:e,y:f,codes:d,name:c});$("#rg2-select-course-file").addClass("valid")},extractV3CourseClassMapping:function(a){var b,c,d;for(b=0;b<a.length;b+=1)c=a[b].getElementsByTagName("CourseName")[0].textContent.trim(),d=a[b].getElementsByTagName("ClassName")[0].textContent.trim(),this.courseClassMapping.push({course:c,className:d});$("#rg2-select-course-file").addClass("valid")},extractCodesFromControlList:function(a,b){var c,d,e,f;for(f=a.getElementsByTagName("CourseControl"),e=[],c=0;c<f.length;c+=1)d=f[c].getElementsByTagName(b)[0].textContent.trim(),this.validControlCode(d)&&e.push(d);return e},extractV2Controls:function(a,b){var c,d,e,f,g;for(g=!1,d={x:0,y:0},c=0;c<a.length;c+=1)e=a[c].getElementsByTagName(b)[0].textContent,f=a[c].getElementsByTagName("ControlPosition"),f.length>0&&this.localWorldfile.valid?(d.x=parseFloat(f[0].getAttribute("x")),d.y=parseFloat(f[0].getAttribute("y")),g=!0):d=this.getXYFromMapPosition(a[c].getElementsByTagName("MapPosition")),this.newcontrols.addControl(e.trim(),d.x,d.y);return g},getXYFromMapPosition:function(a){return{x:a[0].getAttribute("x").replace(",","."),y:a[0].getAttribute("y").replace(",",".")}},validControlCode:function(a){var b,c;for(c=this.newcontrols.controls,b=0;b<c.length;b+=1)if(c[b].code===a)return!0;return!1}},rg2.CourseParser=a}(),function(){function a(a){return this.results=[],this.valid=!0,this.processIOFV2Results(a),{results:this.results,valid:this.valid}}a.prototype={Constructor:a,getDBID:function(a,b){return 0===a.length?b:(a=a[0].textContent.replace(/[\n\r]/g,"").trim(),a?a:b)},getName:function(a){var b;return b=a.getElementsByTagName("Given")[0].textContent+" "+a.getElementsByTagName("Family")[0].textContent,b.replace(/[\n\r]/g,"").trim()},processIOFV2Results:function(a){var b,c,d,e,f,g,h;try{for(b=a.getElementsByTagName("ClassResult"),e=0;e<b.length;e+=1)for(h=b[e].getElementsByTagName("ClassShortName")[0].textContent,c=b[e].getElementsByTagName("PersonResult"),f=0;f<c.length;f+=1)g={},g.course=h,g.name=this.getName(c[f]),g.dbid=this.getDBID(c[f].getElementsByTagName("PersonId"),f),g.club=rg2.utils.extractTextContentZero(c[f].getElementsByTagName("ShortName"),""),d=c[f].getElementsByTagName("Result"),this.extractIOFV2Results(d,g),"DidNotStart"!==g.status&&this.results.push(g)}catch(a){return this.valid=!1,void rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+a.message)}},getStartFinishTimeAsSecs:function(a){var b;return a.length>0?(b=a[0].getElementsByTagName("Clock")[0].textContent,"-"===b.charAt(0)?0:rg2.utils.getSecsFromHHMMSS(b)):0},getPosition:function(a){return a.length>0?parseInt(a[0].textContent,10):""},getTime:function(a){return a.length>0?a[0].textContent.replace(/[\n\r]/g,""):""},extractIOFV2Results:function(a,b){var c,d,e,f;for(c=0;c<a.length;c+=1)b.status=rg2.utils.extractAttributeZero(a[c].getElementsByTagName("CompetitorStatus"),"value",""),b.position=this.getPosition(a[c].getElementsByTagName("ResultPosition")),b.chipid=rg2.utils.extractTextContentZero(a[c].getElementsByTagName("CCardId"),0),b.time=this.getTime(a[c].getElementsByTagName("Time")),d=this.getStartFinishTimeAsSecs(a[c].getElementsByTagName("StartTime")),d>=0?b.starttime=d:b.starttime=0,b.splits="",b.codes=[],f=a[c].getElementsByTagName("SplitTime"),b.controls=f.length,this.extractIOFV2Splits(f,b),e=this.getStartFinishTimeAsSecs(a[c].getElementsByTagName("FinishTime")),b.splits+=Math.max(e-d,0)},extractIOFV2Splits:function(a,b){var c,d;for(c=0;c<a.length;c+=1)c>0&&(b.splits+=";"),d=a[c].getElementsByTagName("Time"),d.length>0?(b.splits+=rg2.utils.getSecsFromHHMMSS(d[0].textContent),b.codes[c]=rg2.utils.extractTextContentZero(a[c].getElementsByTagName("ControlCode"),"")):(b.splits+=0,b.codes[c]="");b.splits+=";"}},rg2.ResultParserIOFV2=a}(),function(){function a(a){return this.results=[],this.valid=!0,this.processIOFV3Results(a),{results:this.results,valid:this.valid}}a.prototype={Constructor:a,getID:function(a,b){var c;return a.length>0?(c=a[0].textContent,c.replace(/[\n\r]/g,""),c.trim()):b},getClub:function(a){return a.length>0?a[0].getElementsByTagName("Name")[0].textContent:""},processIOFV3Results:function(a){var b,c,d,e,f,g,h,i;try{for(b=a.getElementsByTagName("ClassResult"),e=0;e<b.length;e+=1)for(i=b[e].getElementsByTagName("Class"),h=i[0].getElementsByTagName("Name")[0].textContent,c=b[e].getElementsByTagName("PersonResult"),f=0;f<c.length;f+=1)g={},g.course=h,i=c[f].getElementsByTagName("Given")[0].textContent+" "+c[f].getElementsByTagName("Family")[0].textContent,g.name=i.replace(/[\n\r]/g,"").trim(),g.dbid=this.getID(c[f].getElementsByTagName("Id"),f),g.club=this.getClub(c[f].getElementsByTagName("Organisation")),d=c[f].getElementsByTagName("Result"),this.extractIOFV3Results(d,g),"DidNotStart"!==g.status&&this.results.push(g)}catch(a){return this.valid=!1,void rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+a.message)}},getStartFinishTimeAsSeconds:function(a){return a.length>=19?rg2.utils.getSecsFromHHMMSS(a.substr(11,8)):0},getTotalTimeAsSeconds:function(a){if(a.length>0&&a[0].textContent){var b=parseInt(a[0].textContent,10);return b<=3600?rg2.utils.formatSecsAsMMSS(b):rg2.utils.formatSecsAsHHMMSS(b)}return"00:00"},extractIOFV3Results:function(a,b){var c,d,e;for(c=0;c<a.length;c+=1)b.chipid=rg2.utils.extractTextContentZero(a[c].getElementsByTagName("ControlCard"),0),b.position=rg2.utils.extractTextContentZero(a[c].getElementsByTagName("Position"),""),b.status=rg2.utils.extractTextContentZero(a[c].getElementsByTagName("Status"),""),b.time=this.getTotalTimeAsSeconds(a[c].getElementsByTagName("Time")),b.starttime=this.getStartFinishTimeAsSeconds(rg2.utils.extractTextContentZero(a[c].getElementsByTagName("StartTime"),0)),b.splits="",b.codes=[],e=a[c].getElementsByTagName("SplitTime"),this.extractIOFV3Splits(e,b),d=this.getStartFinishTimeAsSeconds(rg2.utils.extractTextContentZero(a[c].getElementsByTagName("FinishTime"),0)),d>0?b.splits+=d-b.starttime:b.splits+=0},extractIOFV3Splits:function(a,b){var c,d;for(d=[],c=0;c<a.length;c+=1)0===a[c].attributes.length&&(b.splits+=rg2.utils.extractTextContentZero(a[c].getElementsByTagName("Time"),0),d.push(rg2.utils.extractTextContentZero(a[c].getElementsByTagName("ControlCode"),"X"+c)),b.splits+=";");b.codes=d,b.controls=b.codes.length}},rg2.ResultParserIOFV3=a}(),function(){function a(a){return this.results=[],this.CSVFormat={},this.separator="",this.valid=!0,this.processResultsCSV(a),{results:this.results,valid:this.valid}}a.prototype={Constructor:a,processResultsCSV:function(a){var b,c,d;b=a.split(/[\r\n|\n]+/),c=b[0].split(",").length-1,d=b[0].split(";").length-1,c>d?this.separator=",":this.separator=";",2===b[0].split(this.separator).length?this.processSpklasseCSVResults(b):(this.getCSVFormat(b[0]),this.processCSVResults(b))},processCSVResults:function(a){var b,c,d;for(b=1;b<a.length;b+=1)c=a[b].split(this.separator),c.length>=this.CSVFormat.FIRST_SPLIT_IDX&&(d=this.extractSingleCSVResult(c),d.valid&&(delete d.valid,this.results.push(d)))},getPosition:function(a){var b;return b=parseInt(a[this.CSVFormat.POSITION_IDX],10),isNaN(b)&&(b=""),b},extractSingleCSVResult:function(a){var b,c;return b={},b.valid=!0,b.chipid=a[this.CSVFormat.CHIP_IDX],b.name=(a[this.CSVFormat.FIRST_NAME_IDX]+" "+a[this.CSVFormat.SURNAME_IDX]).trim().replace(/\"/g,""),b.dbid=a[this.CSVFormat.DB_IDX],b.starttime=rg2.utils.getSecsFromHHMMSS(a[this.CSVFormat.START_TIME_IDX]),b.time=a[this.CSVFormat.TOTAL_TIME_IDX],b.position=this.getPosition(a),b.status=this.getSICSVStatus(a[this.CSVFormat.NC_IDX],a[this.CSVFormat.CLASSIFIER_IDX]),b.club=a[this.CSVFormat.CLUB_IDX].trim().replace(/\"/g,""),b.course=a[this.CSVFormat.COURSE_IDX],""===b.course&&(b.valid=!1),b.controls=parseInt(a[this.CSVFormat.NUM_CONTROLS_IDX],10),c=this.extractSISplits(a,b.controls),b.splits=c.splits,""!==b.splits&&(b.splits+=";"),b.splits+=rg2.utils.getSecsFromHHMMSS(b.time),b.codes=c.codes,b},extractSISplits:function(a,b){var c,d,e,f;for(f=this.CSVFormat.FIRST_SPLIT_IDX,e=this.CSVFormat.FIRST_CODE_IDX,d={},d.splits="",d.codes=[],c=0;c<b;c+=1)a[e]&&(c>0&&(d.splits+=";"),d.codes[c]=a[e],d.splits+=rg2.utils.getSecsFromHHMMSS(a[f])),f+=this.CSVFormat.STEP,e+=this.CSVFormat.STEP;return{splits:d.splits,codes:d.codes}},getCSVFormat:function(a){var b,c,d,e,f,g;for(b=["SI card","Database Id","Surname","First name","nc","Start","Time","Classifier","City","Short","Course","Course controls","Pl","Start punch","Control1","Punch1","Control2"],c=[],d=a.split(this.separator),e=0;e<b.length;e+=1){for(g=!1,f=0;f<d.length;f+=1){if(d[f]===b[e]){c[e]=f,g=!0;break}if("SI card"===b[e]&&("Chipno"===d[f]||"SIcard"===d[f]||"Database Id"===d[f])){c[e]=f,g=!0;break}if("nc"===b[e]&&"Classifier"===d[f]){c[e]=f,g=!0;break}if("City"===b[e]&&"Club"===d[f]){c[e]=f,g=!0;break}if("Pl"===b[e]&&"Place"===d[f]){c[e]=f,g=!0;break}}if(!g)break}g||(c=[1,2,3,4,8,9,11,12,15,18,39,42,43,44,46,47,2]),this.setCSVFormat(c)},setCSVFormat:function(a){this.CSVFormat.CHIP_IDX=a[0],this.CSVFormat.DB_IDX=a[1],this.CSVFormat.SURNAME_IDX=a[2],this.CSVFormat.FIRST_NAME_IDX=a[3],this.CSVFormat.NC_IDX=a[4],this.CSVFormat.START_TIME_IDX=a[5],this.CSVFormat.TOTAL_TIME_IDX=a[6],this.CSVFormat.CLASSIFIER_IDX=a[7],this.CSVFormat.CLUB_IDX=a[8],this.CSVFormat.CLASS_IDX=a[9],this.CSVFormat.COURSE_IDX=a[10],this.CSVFormat.NUM_CONTROLS_IDX=a[11],this.CSVFormat.POSITION_IDX=a[12],this.CSVFormat.START_PUNCH_IDX=a[13],this.CSVFormat.FIRST_CODE_IDX=a[14],this.CSVFormat.FIRST_SPLIT_IDX=a[15],this.CSVFormat.STEP=a[16]-a[14]},getSICSVStatus:function(a,b){return"0"===a||""===a||"N"===a?""===b||"0"===b?"ok":"nok":"nc"},processSpklasseCSVResults:function(a){var b,c,d,e,f=0,g=1;for(e=[],b="",c=0,d=0;d<a.length;d+=1)e=a[d].split(this.separator),2===e.length?(b=e[f],c=parseInt(e[g],10)):this.extractResult(e,b,c)},extractResult:function(a,b,c){var d,e,f=0,g=1,h=2,i=3;d={},d.chipid=0,d.name=(a[f]+" "+a[g]+" "+a[h]).trim(),d.dbid=d.chipid+"__"+d.name,d.starttime=rg2.utils.getSecsFromHHMM(a[i]),d.club=a[h],d.course=b,d.controls=c,e=this.extractSpklasseSplits(a),d.splits=e.splits,d.codes=e.codes,d.time=rg2.utils.formatSecsAsMMSS(e.totaltime),this.results.push(d)},extractSpklasseSplits:function(a){var b,c,d,e,f,g=4;for(c="",d=[],f=a.length-g,e=0,b=0;b<f;b+=1)b>0&&(c+=";"),d[b]="X",e+=rg2.utils.getSecsFromHHMMSS(a[b+g]),c+=e;return{splits:c,codes:d,totaltime:e}}},rg2.ResultParserCSV=a}(),function(){function a(a,b){var c;return this.results=[],this.resultCourses=[],this.valid=!0,c=this.processResults(a,b),this.results=c.results,this.valid=c.valid,this.getCoursesFromResults(),{results:this.results,resultCourses:this.resultCourses,valid:this.valid}}a.prototype={Constructor:a,processResults:function(a,b){switch(b){case"CSV":return new rg2.ResultParserCSV(a.target.result);case"XML":return this.processResultsXML(a.target.result);default:return rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file."),{results:[],valid:!1}}},getCoursesFromResults:function(){var a,b,c;for(a=0;a<this.results.length;a+=1){for(c=!1,b=0;b<this.resultCourses.length;b+=1)if(this.resultCourses[b].course===this.results[a].course){c=!0;break}c||this.resultCourses.push({course:this.results[a].course,courseid:rg2.config.DO_NOT_SAVE_COURSE})}},processResultsXML:function(a){var b,c,d;c="";try{if(b=$.parseXML(a),d=b.getElementsByTagName("ResultList"),0===d.length)return rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file. ResultList element missing."),{results:[],valid:!1};c=rg2.utils.extractAttributeZero(b.getElementsByTagName("IOFVersion"),"version",""),""===c&&(c=rg2.utils.extractAttributeZero(b.getElementsByTagName("ResultList"),"iofVersion",""))}catch(a){return rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file."),{results:[],valid:!1}}switch(c){case"2.0.3":return new rg2.ResultParserIOFV2(b);case"3.0":return new rg2.ResultParserIOFV3(b);default:return rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+c+" not supported."),{results:[],valid:!1}}}},rg2.ResultParser=a}(),function(){var a={showItems:function(a,b){var c;for(c=0;c<a.length;c+=1)b?$(a[c]).show():$(a[c]).hide()},initialiseUI:function(){var a;a=["#rg2-animation-controls","#rg2-create-tab","#rg2-edit-tab","#rg2-map-tab","#rg2-draw-tab","#rg2-results-tab","#rg2-courses-tab","#rg2-events-tab","#rg2-hide-info-panel-control"],this.showItems(a,!1),$("#rg2-manage-login").show(),$("#rg2-info-panel").tabs("disable",rg2.config.TAB_EVENTS).tabs("option","active",rg2.config.TAB_LOGIN),$("#rg2-manage-create-body").accordion({collapsible:!0,heightStyle:"content"}),$("#manage-edit-options").accordion({collapsible:!0,heightStyle:"content"}),$("#rg2-manage-map-body").accordion({collapsible:!0,heightStyle:"content"})},setUIVisibility:function(){var a;a=["#rg2-draw-courses","#rg2-manage-login","#rg2-login-tab"],this.showItems(a,!1),a=["#rg2-manage-create","#rg2-create-tab","#rg2-edit-tab","#rg2-map-tab","#rg2-hide-info-panel-control"],this.showItems(a,!0),$("#rg2-event-date-edit").datepicker({dateFormat:"yy-mm-dd",showWeek:!0,firstDay:1}),$("#rg2-event-comments").focus(function(){var a=$("#rg2-event-comments").val();a===rg2.t(rg2.config.EFAULT_EVENT_COMMENT)&&$("#rg2-event-comments").val("")})},displayCourseInfo:function(a){this.displayInfoDialog(a,"Course")},displayResultInfo:function(a){this.displayInfoDialog(a,"Result")},displayInfoDialog:function(a,b){a&&($("#rg2-manage-"+b.toLowerCase()+"s").empty().html(a),$("#rg2-manage-"+b.toLowerCase()+"s").dialog({title:b+" details",dialogClass:"rg2-"+b.toLowerCase()+"-info-dialog",resizable:!0,width:"auto",maxHeight:.9*window.innerHeight,buttons:{Ok:function(){$(this).dialog("close")}}}))},createMapDropdown:function(a){var b,c;for($("#rg2-map-selected").empty(),b=document.getElementById("rg2-map-selected"),b.options.add(rg2.utils.generateOption(rg2.config.INVALID_MAP_ID,"Select map")),c=a.length-1;c>-1;c-=1)b.options.add(rg2.utils.generateOption(c,a[c].mapid+": "+rg2.he.decode(a[c].name)))},createGeorefDropdown:function(a){var b;$("#rg2-georef-selected").empty(),b=document.getElementById("rg2-georef-selected"),b=a.getDropdown(b)},createEventEditDropdown:function(){var a;$("#rg2-event-selected").empty(),a=document.getElementById("rg2-event-selected"),a=rg2.events.getEventEditDropdown(a)},createRouteDeleteDropdown:function(a){var b,c,d;for($("#rg2-route-selected").empty(),b=document.getElementById("rg2-route-selected"),c=rg2.results.getRoutesForEvent(a),d=0;d<c.length;d+=1)b.options.add(rg2.utils.generateOption(c[d].resultid,c[d].resultid+": "+rg2.he.decode(c[d].name)+" on "+rg2.he.decode(c[d].coursename)))},createEventLevelDropdown:function(a){var b,c,d,e;for($("#"+a).empty(),b=document.getElementById(a),c=["Select level","Training","Local","Regional","National","International"],d=["X","T","L","R","N","I"],e=0;e<c.length;e+=1)b.options.add(rg2.utils.generateOption(d[e],c[e]))},setEvent:function(a){var b;void 0!==a&&null!==a?(b=rg2.events.getEventInfo(a),rg2.loadEvent(b.id)):(rg2.utils.setButtonState("disable",["#btn-delete-event","#btn-update-event","#btn-delete-route"]),$("#rg2-event-name-edit").val(""),$("#rg2-club-name-edit").val(""),$("#rg2-event-date-edit").val(""),$("#rg2-event-level-edit").val(""),$("#rg2-edit-event-comments").val(""),$("#rg2-route-selected").empty(),$("#chk-edit-read-only").prop("checked",!1))},eventFinishedLoading:function(a){$("#rg2-event-name-edit").empty().val(rg2.he.decode(a.name)),$("#rg2-club-name-edit").empty().val(rg2.he.decode(a.club)),$("#rg2-event-date-edit").empty().val(a.date),$("#rg2-event-level-edit").val(a.rawtype),$("#rg2-edit-event-comments").empty().val(rg2.he.decode(a.comment)),$("#chk-edit-read-only").prop("checked",a.locked),rg2.utils.setButtonState("enable",["#btn-delete-event","#btn-update-event","#btn-delete-route"]),this.createRouteDeleteDropdown(a.id)},doCancelDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy")},doCancelDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy")},doCancelUpdateEvent:function(){$("#event-update-dialog").dialog("destroy")},doCancelCreateEvent:function(){$("#event-create-dialog").dialog("destroy")},doCancelAddMap:function(){$("#add-map-dialog").dialog("destroy")}};rg2.managerUI=a}();
//# sourceMappingURL=rg2manager-1.5.4.min.js.map
=======
// Version 1.5.5 2019-05-03T12:12:01+0100;

!function(){function e(e){this.user=new rg2.User(e),this.newMap=new rg2.Map,this.georefsystems=new rg2.Georefs,this.eventName=null,this.eventDate=null,this.eventLevel=null,this.mapIndex=rg2.config.INVALID_MAP_ID,this.club=null,this.comments=null,this.format=rg2.config.FORMAT_NORMAL,this.newcontrols=new rg2.Controls,this.courses=[],this.mapping=[],this.mapLoaded=!1,this.coursesGeoreferenced=!1,this.controlsAdjusted=!1,this.drawingCourses=!1,this.drawnCourse={},this.results=[],this.variants=[],this.resultCourses=[],this.mapWidth=0,this.mapHeight=0,this.mapFile=void 0,this.resultsOrCourseFile=void 0,this.resultsFileFormat="",this.encodings=["UTF-8","ISO-8859-1","windows-1251"],this.errorCount=[],this.encodingIndex=0,this.useThisEncoding=!1,this.backgroundLocked=!1,this.sortResults=!1,this.handle={x:null,y:null},this.maps=[],this.localworldfile=new rg2.Worldfile(0),this.worldfile=new rg2.Worldfile(0),this.georefmap=L.map("rg2-world-file-map"),this.initialiseMap(),this.initialiseUI()}e.prototype={Constructor:e,initialiseUI:function(){var e;e=this,$("#btn-login").button(),$("rg2-manager-courses").hide(),$("rg2-manager-results").hide(),$("#chk-read-only").prop("checked",!1),$("#rg2-manager-login-form").submit(function(){return e.user.setDetails($("#rg2-user-name").val(),$("#rg2-password").val())?e.logIn():rg2.utils.showWarningDialog("Login failed","Please enter user name and password of at least five characters"),!1})},initialiseMap:function(){L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(this.georefmap)},logIn:function(){var e,t,s;return e=rg2Config.json_url+"?type=login",t=JSON.stringify(this.user.encodeUser()),s=this,$.ajax({type:"POST",dataType:"json",data:t,url:e,cache:!1,success:function(e){s.user.y=e.keksi,e.ok?s.enableEventEdit():rg2.utils.showWarningDialog("Login failed","Login failed. Please try again.")},error:function(){rg2.utils.showWarningDialog("Login failed","User name or password incorrect. Please try again.")}}),!1},setButtons:function(){var t;t=this,$("#btn-create-event").button().click(function(){t.confirmCreateEvent()}).button("enable"),$("#btn-update-event").button().click(function(){t.confirmUpdateEvent()}).button("disable"),$("#btn-delete-route").button().click(function(){t.confirmDeleteRoute()}).button("disable"),$("#btn-delete-event").button().click(function(){t.confirmDeleteEvent()}).button("disable"),$("#btn-add-map").button().click(function(){t.confirmAddMap()}).button("disable"),$("#btn-draw-courses").button().click(function(){t.startDrawingCourses()}),$("#rg2-load-georef-file").button().change(function(e){t.readGeorefFile(e)}),$("#rg2-load-map-file").button().change(function(e){t.validateMapUpload(this.files[0]),t.readMapFile(e)}),$("#rg2-load-results-file").button().click(function(e){t.mapLoaded||(rg2.utils.showWarningDialog("No map loaded","Please load a map file before adding results."),e.preventDefault())}).change(function(e){t.resultsOrCourseFile=e.target.files[0],t.initialiseEncodings(),t.readResults()}),$("#btn-move-map-and-controls").click(function(e){t.toggleMoveAll(e.target.checked)}),$("#btn-no-results").click(function(e){t.toggleResultsRequired(e.target.checked)}),$("#btn-sort-results").click(function(e){t.toggleSortResults(e.target.checked)}),$("#rg2-load-course-file").button().click(function(e){t.mapLoaded||(rg2.utils.showWarningDialog("No map loaded","Please load a map file before adding courses."),e.preventDefault())}).change(function(e){t.readCourses(e)})},validateMapUpload:function(t){var e,s,r;(e=new FileReader).onload=function(e){(s=new Image).src=e.target.result,s.onload=function(){var e;e="The uploaded map file is "+(r=Math.round(t.size/1024/1024))+"MB ("+this.width,e+=" x "+this.height+"). It is recommended that you only use maps under",e+=" "+rg2.config.FILE_SIZE_WARNING+"MB. Please see the ",e+="<a href='https://github.com/Maprunner/rg2/wiki/Map-files'>RG2 wiki</a> for ",e+="guidance on how to create map files.",r>rg2.config.FILE_SIZE_WARNING&&rg2.utils.showWarningDialog("Oversized map upload",e)}},e.readAsDataURL(t)},initialiseEncodings:function(){this.encodingIndex=0,this.errorCount=[],this.useThisEncoding=!1},enableEventEdit:function(){var t=this;rg2.managerUI.setUIVisibility(),this.getMaps(),this.setButtons(),rg2.managerUI.createEventLevelDropdown("rg2-event-level"),rg2.managerUI.createEventLevelDropdown("rg2-event-level-edit"),rg2.managerUI.createGeorefDropdown(this.georefsystems),rg2.managerUI.createEventEditDropdown(),$("#rg2-event-level").change(function(){t.eventLevel=$("#rg2-event-level").val(),"X"!==t.eventLevel?$("#rg2-select-event-level").addClass("valid"):$("#rg2-select-event-level").removeClass("valid")}),$("#rg2-map-selected").change(function(){t.mapIndex=parseInt($("#rg2-map-selected").val(),10),t.mapIndex!==rg2.config.INVALID_MAP_ID?($("#rg2-manager-map-select").addClass("valid"),rg2.loadNewMap(rg2Config.maps_url+"/"+t.maps[t.mapIndex].mapfilename)):($("#rg2-manager-map-select").removeClass("valid"),t.mapLoaded=!1,t.mapWidth=0,t.mapHeight=0)}),$("#rg2-event-date").datepicker({dateFormat:"yy-mm-dd",onSelect:function(e){t.setDate(e)}}),$("#rg2-event-name").on("change",function(){t.setEventName()}),$("#rg2-map-name").on("change",function(){t.setMapName()}),$("#rg2-club-name").on("change",function(){t.setClub()}),$("#rg2-new-course-name").on("change",function(){t.setCourseName()}),$("#rg2-manager-event-select").change(function(){rg2.managerUI.setEvent(parseInt($("#rg2-event-selected").val(),10))}),$("#rg2-georef-type").change(function(){t.setGeoref($("#rg2-georef-selected").val())}),$("#rg2-info-panel").tabs("option","active",rg2.config.TAB_CREATE)},getMaps:function(){var t,s;s=this,$.getJSON(rg2Config.json_url,{type:"maps",cache:!1}).done(function(e){for(s.maps.length=0,console.log("Maps: "+e.data.maps.length),t=0;t<e.data.maps.length;t+=1)s.maps.push(new rg2.Map(e.data.maps[t]));rg2.managerUI.createMapDropdown(s.maps),$("#btn-toggle-controls").show()}).fail(function(){rg2.utils.showWarningDialog("Map request failed","Error getting map list.")})},setGeoref:function(e){null!==e&&this.convertWorldFile(e)},eventListLoaded:function(){rg2.managerUI.createEventEditDropdown()},eventFinishedLoading:function(){var e;e=parseInt($("#rg2-event-selected").val(),10),rg2.managerUI.eventFinishedLoading(rg2.events.getEventInfo(e))},startDrawingCourses:function(){this.mapLoaded?(this.drawingCourses=!0,this.courses.length=0,this.newcontrols.deleteAllControls(),this.drawnCourse.name="Course",this.drawnCourse.x=[],this.drawnCourse.y=[],this.drawnCourse.codes=[],this.drawnCourse.courseid=0,$("#rg2-new-course-name").val("Course"),$("#rg2-draw-courses").show()):rg2.utils.showWarningDialog("No map selected","Please load a map before drawing courses")},displayCourseAllocations:function(){var e,t;if(this.courses.length&&this.resultCourses.length){for(t="<div id='rg2-course-allocations'><table><thead><tr><th>Results</th><th>Course</th></tr></thead><tbody>",e=0;e<this.resultCourses.length;e+=1)t+="<tr><td>"+this.resultCourses[e].course+"</td><td>"+this.createCourseDropdown(this.resultCourses[e].course,e)+"</td></tr>";t+="</tbody></table></div>",$("#rg2-course-allocations").empty().append(t)}},createResultCourseMapping:function(){var e;if(this.format===rg2.config.FORMAT_NO_RESULTS)for(e=this.resultCourses.length=0;e<this.courses.length;e+=1)this.resultCourses.push({courseid:this.courses[e].courseid,course:this.courses[e].name})},validateData:function(){return this.eventName?this.mapIndex===rg2.config.INVALID_MAP_ID?"No map selected.":this.club?this.eventDate?this.eventLevel?this.format?0!==this.courses.length||this.drawingCourses?0===this.results.length&&this.format!==rg2.config.FORMAT_NO_RESULTS?"No results information. Check your results file.":this.controlsAdjusted?"OK":"Controls have not been adjusted on the map.":"No course information. Check your course XML file.":"Event format is not valid.":"Event level is not valid.":"Date is not valid.":"Club name is not valid.":"Event name is not valid."},confirmCreateEvent:function(){var e,t;"OK"===(e=this.validateData())?((t={selector:"<div id='event-create-dialog'>Are you sure you want to create this event?</div>",title:"Confirm event creation",classes:"rg2-confirm-create-event-dialog",doText:"Create event"}).onDo=this.doCreateEvent.bind(this),t.onCancel=rg2.managerUI.doCancelCreateEvent.bind(this),rg2.utils.createModalDialog(t)):rg2.utils.showWarningDialog("Event set-up incomplete",e+" Please enter all necessary information and make sure controls are aligned before creating the event.")},doCreateEvent:function(){var t,e;$("#event-create-dialog").dialog("destroy"),e=(t=this).generateNewEventData(),$("#rg2-load-progress-label").text("Creating event"),$("#rg2-load-progress").show(),$.ajax({data:e,type:"POST",url:rg2Config.json_url+"?type=createevent",dataType:"json",success:function(e){t.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Event created",t.eventName+" has been added with id "+e.newid+"."),window.open(rg2Config.json_url.replace("rg2api.php","")+"#"+e.newid),rg2.getEvents(),rg2.managerUI.setEvent()):rg2.utils.showWarningDialog("Save failed",e.status_msg+" Failed to create event. Please try again.")},error:function(){rg2.utils.showWarningDialog("Save failed"," Failed to create event.")},complete:function(){$("#rg2-load-progress-label").text(""),$("#rg2-load-progress").hide()}})},generateNewEventData:function(){var e,t,s,r;for((e={}).name=this.eventName,e.mapid=this.maps[this.mapIndex].mapid,e.eventdate=this.eventDate,(t=$("#rg2-event-comments").val())===rg2.config.DEFAULT_EVENT_COMMENT?e.comments="":e.comments=t,e.locked=$("#chk-read-only").prop("checked"),e.club=this.club,e.format=this.format,$("#btn-score-event").prop("checked")&&(e.format=rg2.config.FORMAT_SCORE_EVENT),e.level=this.eventLevel,this.drawingCourses&&(this.courses.push(this.drawnCourse),this.createResultCourseMapping()),this.setControlLocations(),this.mapResultsToCourses(),this.renumberResults(),e.format===rg2.config.FORMAT_SCORE_EVENT&&(this.extractVariants(),e.variants=this.variants.slice(0)),e.courses=this.courses.slice(0),this.sortResults?e.results=this.results.slice(0).sort(this.sortResultItems):e.results=this.results.slice(0),r=0;r<e.results.length;r+=1)delete e.results[r].codes,delete e.results[r].chipid,delete e.results[r].club;return s=this.user.encodeUser(),e.x=s.x,e.y=s.y,JSON.stringify(e)},hasZeroTime:function(e){return 0===e||"0"===e||"0:00"===e||"00:00"===e},sortResultItems:function(e,t){return e.courseid!==t.courseid?e.courseid-t.courseid:""!==e.position&&""!==t.position?e.position-t.position:""===e.position&&""!==t.position?1:""!==e.position&&""===t.position?-1:this.rg2.Manager.prototype.hasZeroTime(e.time)&&this.rg2.Manager.prototype.hasZeroTime(t.time)?e.name-t.name:e.time-t.time},renumberResults:function(){var e,t,s;for(t=[],e=0;e<this.results.length;e+=1)(s=this.getCourseIDForResult(this.results[e].course))!==rg2.config.DO_NOT_SAVE_COURSE&&(this.results[e].courseid=s,this.results[e].course=this.getCourseName(s),this.results[e].variantid="",t.push(this.results[e]));this.results=t},getCourseName:function(e){var t;for(t=0;t<this.courses.length;t+=1)if(this.courses[t].courseid===e)return this.courses[t].name;return 0},mapResultsToCourses:function(){var e,t,s,r;for(s=[],r=1,e=0;e<this.resultCourses.length;e+=1)(t=this.drawingCourses?0:parseInt($("#rg2-alloc-"+e).val(),10))!==rg2.config.DO_NOT_SAVE_COURSE&&(0===this.courses[t].courseid?(this.courses[t].courseid=r,s.push(this.courses[t]),this.resultCourses[e].courseid=r,r+=1):this.resultCourses[e].courseid=this.courses[t].courseid);this.courses=s},createCourseDropdown:function(e,t){var s,r,o,n;for(o=-1,s=0;s<this.courses.length;s+=1)if(this.courses[s].name===e){o=s;break}if(-1===o&&0<this.mapping.length)for(s=0;s<this.mapping.length;s+=1)if(this.mapping[s].className===e){for(r=0;r<this.courses.length;r+=1)if(this.courses[r].name===this.mapping[s].course){o=r;break}break}for(n="<select id='rg2-alloc-"+t+"'><option value="+rg2.config.DO_NOT_SAVE_COURSE,-1===o&&(n+=" selected"),n+=">Do not save</option>",s=0;s<this.courses.length;s+=1)n+="<option value="+s,o===s&&(n+=" selected"),n+=">"+this.courses[s].name+"</option>";return n+="</select>"},extractVariants:function(){var e,t,s,r;for(e=this.variants.length=0;e<this.results.length;e+=1){for(s=this.results[e].codes,t=0;t<this.courses.length;t+=1)if(this.courses[t].courseid===this.results[e].courseid){r=this.courses[t];break}s.unshift(r.codes[0]),s.push(r.codes[r.codes.length-1]),this.results[e].variantid=this.getVariantID(this.results[e].codes,this.results[e].courseid)}},getVariantID:function(e,t){var s,r,o,n,i,a,l;for(n=[],i=[],s=l=0;s<this.variants.length;s+=1)if(this.variants[s].codes.length===e.length){for(a=!0,r=0;r<e.length;r+=1)if(this.variants[s].codes[r]!==e[r]){a=!1;break}if(a){l=s+1;break}}if(0===l){for(l=this.variants.length+1,s=0;s<e.length;s+=1)o=this.getControlXY(e[s]),n.push(o.x),i.push(o.y);this.variants.push({x:n,y:i,id:l,courseid:t,name:"Variant "+l,codes:e})}return l},getCourseIDForResult:function(e){var t;for(t=0;t<this.resultCourses.length;t+=1)if(this.resultCourses[t].course===e)return this.resultCourses[t].courseid;return 0},setControlLocations:function(){var e,t,s;for(e=0;e<this.courses.length;e+=1)for(t=0;t<this.courses[e].codes.length;t+=1)s=this.getControlXY(this.courses[e].codes[t]),this.courses[e].x[t]=s.x,this.courses[e].y[t]=s.y},getControlXY:function(e){var t,s;for(s={x:0,y:0},t=0;t<this.newcontrols.controls.length;t+=1)if(this.newcontrols.controls[t].code===e)return s.x=Math.round(this.newcontrols.controls[t].x),s.y=Math.round(this.newcontrols.controls[t].y),s;return s},confirmUpdateEvent:function(){var e;(e={selector:"<div id='event-update-dialog'>Are you sure you want to update this event?</div>",title:"Confirm event update",classes:"rg2-confirm-update-dialog",doText:"Update event"}).onDo=this.doUpdateEvent.bind(this),e.onCancel=rg2.managerUI.doCancelUpdateEvent.bind(this),rg2.utils.createModalDialog(e)},doUpdateEvent:function(){var t,e,s,r,o,n;$("#event-update-dialog").dialog("destroy"),t=$("#rg2-event-selected").val(),e=rg2Config.json_url+"?type=editevent&id="+t,(s={}).comments=$("#rg2-edit-event-comments").val(),s.locked=$("#chk-edit-read-only").prop("checked"),s.name=$("#rg2-event-name-edit").val(),s.type=$("#rg2-event-level-edit").val(),s.eventdate=$("#rg2-event-date-edit").val(),s.club=$("#rg2-club-name-edit").val(),n=this.user.encodeUser(),s.x=n.x,s.y=n.y,r=JSON.stringify(s),o=this,$.ajax({data:r,type:"POST",url:e,dataType:"json",success:function(e){o.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Event updated","Event "+t+" has been updated."),rg2.events.setActiveEventID(null),rg2.ui.setTitleBar(),rg2.getEvents(),rg2.managerUI.setEvent()):rg2.utils.showWarningDialog("Update failed",e.status_msg+". Event update failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Update failed",t+". Event update failed.")}})},confirmDeleteRoute:function(){var e;(e={selector:"<div id='route-delete-dialog'>This route will be permanently deleted. Are you sure?</div>",title:"Confirm route delete",classes:"rg2-confirm-route-delete-dialog",doText:"Delete route"}).onDo=this.doDeleteRoute.bind(this),e.onCancel=rg2.managerUI.doCancelDeleteRoute.bind(this),rg2.utils.createModalDialog(e)},doDeleteRoute:function(){var e,t,s,r,o;$("#route-delete-dialog").dialog("destroy"),e=$("#rg2-event-selected").val(),s=$("#rg2-route-selected").val(),t=rg2Config.json_url+"?type=deleteroute&id="+e+"&routeid="+s,r=JSON.stringify(this.user.encodeUser()),o=this,$.ajax({data:r,type:"POST",url:t,dataType:"json",success:function(e){o.user.y=e.keksi,e.ok?rg2.utils.showWarningDialog("Route deleted","Route "+s+" has been deleted."):rg2.utils.showWarningDialog("Delete failed",e.status_msg+". Delete failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Delete failed",t+". Delete failed.")}})},confirmDeleteEvent:function(){var e;(e={selector:"<div id='event-delete-dialog'>This event will be deleted. Are you sure?</div>",title:"Confirm event delete",classes:"rg2-confirm-delete-event-dialog",doText:"Delete event"}).onDo=this.doDeleteEvent.bind(this),e.onCancel=rg2.managerUI.doCancelDeleteEvent.bind(this),rg2.utils.createModalDialog(e)},doDeleteEvent:function(){var t,e,s,r;$("#event-delete-dialog").dialog("destroy"),t=$("#rg2-event-selected").val(),e=rg2Config.json_url+"?type=deleteevent&id="+t,s=JSON.stringify(this.user.encodeUser()),r=this,$.ajax({data:s,type:"POST",url:e,dataType:"json",success:function(e){r.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Event deleted","Event "+t+" has been deleted."),rg2.getEvents(),rg2.managerUI.setEvent(),$("#rg2-event-selected").empty()):rg2.utils.showWarningDialog("Delete failed",e.status_msg+". Event delete failed. Please try again.")},error:function(e,t){rg2.utils.showWarningDialog("Delete failed",t+". Delete failed.")}})},readResults:function(){var e,t,s;t=new FileReader,s=this,t.onerror=function(){rg2.utils.showWarningDialog("Results file error","The selected results file could not be read.")},t.onload=function(e){s.checkResultsFileEncoding(e)},"XML"===(e=this.resultsOrCourseFile.name.substr(-3,3).toUpperCase())||"CSV"===e?(this.resultsFileFormat=e,t.readAsText(this.resultsOrCourseFile,this.encodings[this.encodingIndex])):rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file.")},checkResultsFileEncoding:function(e){var t,s,r;if(0===(t=this.testForInvalidCharacters(e.target.result))||this.useThisEncoding)this.processResultFile(e);else{if(this.errorCount[this.encodingIndex]=t,this.encodingIndex+=1,this.encodingIndex===this.encodings.length){for(s=99999,r=0;r<this.encodings.length;r+=1)s>this.errorCount[r]&&(this.encodingIndex=r,s=this.errorCount[r]);this.useThisEncoding=!0}this.readResults()}},processResultFile:function(e){var t=new rg2.ResultParser(e,this.resultsFileFormat);this.results=t.results,this.resultCourses=t.resultCourses,t.valid?$("#rg2-select-results-file").addClass("valid"):$("#rg2-select-results-file").removeClass("valid"),rg2.managerUI.displayResultInfo(this.getResultInfoAsHTML()),this.displayCourseAllocations()},readCourses:function(e){var t,s;(t=new FileReader).onerror=function(){rg2.utils.showWarningDialog("Course file error","The selected course file could not be read.")},s=this,t.onload=function(e){s.processCourseFile(e)},t.readAsText(e.target.files[0])},processCourseFile:function(e){var t;this.coursesGeoreferenced=!1,this.backgroundLocked=!1,$("#btn-move-map-and-controls").prop("checked",!1),this.handle={x:null,y:null},this.newcontrols.deleteAllControls(),t=new rg2.CourseParser(e,this.worldfile,this.localworldfile),this.courses=t.courses,this.newcontrols=t.newcontrols,this.mapping=t.mapping,this.coursesGeoreferenced=t.georeferenced,rg2.managerUI.displayCourseInfo(this.getCourseInfoAsHTML()),this.createResultCourseMapping(),this.displayCourseAllocations(),this.fitControlsToMap(),rg2.redraw(!1)},getCourseInfoAsHTML:function(){var e,t;if(this.courses.length){for(e="<table><thead><tr><th>Course</th><th>Name</th><th>Controls</th></tr></thead><tbody>",t=0;t<this.courses.length;t+=1)e+="<tr><td>"+(t+1)+"</td><td>"+this.courses[t].name+"</td><td>"+(this.courses[t].codes.length-2)+"</td></tr>";e+="</tbody></table>"}else e="";return e},getResultInfoAsHTML:function(){var e,t,s,r;if(this.results.length){for(e="<table><thead><tr><th>Course</th><th>Winner</th><th>Time</th><th>Runners</th></tr></thead><tbody>",r=null,t=s=0;t<this.results.length;t+=1)this.results[t].course!==r&&(null!==r&&(e+="<td>"+s+"</td></tr>",s=0),e+="<tr><td>"+this.results[t].course+"</td><td>"+this.results[t].name+"</td><td>"+this.results[t].time+"</td>",r=this.results[t].course),s+=1;e+="<td>"+s+"</td></tr></tbody></table>"}else e="No valid results found.";return e},testForInvalidCharacters:function(e){var t,s;for(t=s=0;t<e.length;t+=1)65533===e.charCodeAt(t)&&(s+=1);return console.log("Encoding: "+this.encodings[this.encodingIndex]+", Invalid characters: "+s),s},readMapFile:function(e){var t,s,r;t=new FileReader,s=this,t.onload=function(e){s.processMap(e)},"JPG"===(r=e.target.files[0].name.substr(-3,3).toUpperCase())||"GIF"===r?(this.mapFile=e.target.files[0],t.readAsDataURL(e.target.files[0])):rg2.utils.showWarningDialog("File type error",e.target.files[0].name+" is not recognised. Only .jpg and .gif files are supported at present.")},mapLoadCallback:function(){var e;this.mapLoaded=!0,this.mapIndex!==rg2.config.INVALID_MAP_ID&&(this.localworldfile=this.maps[this.mapIndex].localworldfile,this.worldfile=this.maps[this.mapIndex].worldfile),e=rg2.getMapSize(),this.mapWidth=e.width,this.mapHeight=e.height,this.fitControlsToMap(),rg2.redraw(!1)},processMap:function(e){var t;rg2.loadNewMap(e.target.result),$("#rg2-select-map-file").addClass("valid"),this.mapLoaded=!0,t=rg2.getMapSize(),this.mapWidth=t.width,this.mapHeight=t.height,this.fitControlsToMap(),rg2.redraw(!1),$("#btn-add-map").button("enable")},fitControlsToMap:function(){var e,t,s;if(t=!1,this.mapLoaded&&0<this.newcontrols.controls.length){if(s=this.getBoundingBox(),this.coursesGeoreferenced&&(s.maxX<0||s.minX>this.mapWidth||s.minY>this.mapHeight||s.maxY<0?rg2.utils.showWarningDialog("Course file problem","Your course file does not match the map co-ordinates. Please check you have selected the correct file."):t=!0),t)this.backgroundLocked=!0,this.controlsAdjusted=!0,$("#btn-move-map-and-controls").prop("checked",!0);else for(.8,e=0;e<this.newcontrols.controls.length;e+=1)this.newcontrols.controls[e].x=(this.newcontrols.controls[e].x-s.minX)*(this.mapWidth/s.xRange)*.8+this.mapWidth*(1-.8)*.5,this.newcontrols.controls[e].y=this.mapHeight-(this.newcontrols.controls[e].y-s.minY)*(this.mapHeight/s.yRange)*.8-this.mapHeight*(1-.8)*.5;this.copyXYToOldXY(),this.newcontrols.displayAllControls()}},getBoundingBox:function(){var e,t;for((e={}).minX=this.newcontrols.controls[0].x,e.maxX=this.newcontrols.controls[0].x,e.minY=this.newcontrols.controls[0].y,e.maxY=this.newcontrols.controls[0].y,t=1;t<this.newcontrols.controls.length;t+=1)e.maxX=Math.max(e.maxX,this.newcontrols.controls[t].x),e.maxY=Math.max(e.maxY,this.newcontrols.controls[t].y),e.minX=Math.min(e.minX,this.newcontrols.controls[t].x),e.minY=Math.min(e.minY,this.newcontrols.controls[t].y);return e.xRange=e.maxX-e.minX,e.yRange=e.maxY-e.minY,e},copyXYToOldXY:function(){var e;for(e=0;e<this.newcontrols.controls.length;e+=1)this.newcontrols.controls[e].oldX=this.newcontrols.controls[e].x,this.newcontrols.controls[e].oldY=this.newcontrols.controls[e].y},setClub:function(){this.club=$("#rg2-club-name").val(),this.club?$("#rg2-select-club-name").addClass("valid"):$("#rg2-select-club-name").removeClass("valid")},setEventName:function(){this.eventName=$("#rg2-event-name").val(),this.eventName?$("#rg2-select-event-name").addClass("valid"):$("#rg2-select-event-name").removeClass("valid")},setCourseName:function(){var e=$("#rg2-new-course-name").val();e&&(this.drawnCourse.name=e)},setMapName:function(){this.newMap.name=$("#rg2-map-name").val(),this.newMap.name?$("#rg2-select-map-name").addClass("valid"):$("#rg2-select-map-name").removeClass("valid")},setDate:function(e){this.eventDate=e,this.eventDate?$("#rg2-select-event-date").addClass("valid"):$("#rg2-select-event-date").removeClass("valid")},drawControls:function(){if(this.mapLoaded&&0<this.newcontrols.controls.length){this.newcontrols.drawControls(!0);var e=rg2.getOverprintDetails();null!==this.handle.x&&(rg2.ctx.lineWidth=e.overprintWidth,rg2.ctx.strokeStyle=rg2.config.HANDLE_COLOUR,rg2.ctx.fillStyle=rg2.config.HANDLE_COLOUR,rg2.ctx.globalAlpha=1,rg2.ctx.beginPath(),rg2.ctx.arc(this.handle.x,this.handle.y,rg2.config.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.fill(),rg2.ctx.beginPath(),rg2.ctx.arc(this.handle.x,this.handle.y,2*rg2.config.HANDLE_DOT_RADIUS,0,2*Math.PI,!1),rg2.ctx.stroke())}},adjustControls:function(e,t,s){var r,o,n,i,a,l,g;if(this.backgroundLocked||s===rg2.config.RIGHT_CLICK)rg2.ctx.translate(t.x-e.x,t.y-e.y);else if(this.controlsAdjusted=!0,null!==this.handle.x){if(l=(t.x-this.handle.x)/(e.x-this.handle.x),g=(t.y-this.handle.y)/(e.y-this.handle.y),isFinite(l)&&isFinite(g))for(r=0;r<this.newcontrols.controls.length;r+=1)o=this.newcontrols.controls[r].oldX-this.handle.x,n=this.newcontrols.controls[r].oldY-this.handle.y,this.newcontrols.controls[r].x=o*l+this.handle.x,this.newcontrols.controls[r].y=n*g+this.handle.y}else for(i=t.x-e.x,a=t.y-e.y,r=0;r<this.newcontrols.controls.length;r+=1)this.newcontrols.controls[r].x=this.newcontrols.controls[r].oldX+i,this.newcontrols.controls[r].y=this.newcontrols.controls[r].oldY+a},dragEnded:function(){this.mapLoaded&&0<this.newcontrols.controls.length&&this.copyXYToOldXY()},mouseUp:function(e,t){if(this.drawingCourses)return this.addNewControl(e,t),void(this.controlsAdjusted=!0);this.mapLoaded&&0<this.newcontrols.controls.length&&(null===this.handle.x?this.handle={x:e,y:t}:this.handle={x:null,y:null})},addNewControl:function(e,t){var s;s=0===this.newcontrols.controls.length?"S"+(this.newcontrols.controls.length+1):"X"+(this.newcontrols.controls.length+1),this.newcontrols.addControl(s,e,t),this.newcontrols.displayAllControls(),this.drawnCourse.codes.push(s),this.drawnCourse.x.push(e),this.drawnCourse.y.push(t)},toggleMoveAll:function(e){this.backgroundLocked=e},toggleSortResults:function(e){this.sortResults=e},toggleResultsRequired:function(e){e?(this.format=rg2.config.FORMAT_NO_RESULTS,this.createResultCourseMapping()):this.format=rg2.config.FORMAT_NORMAL},confirmAddMap:function(){var e;(e={selector:"<div id='add-map-dialog'>Are you sure you want to add this map?</div>",title:"Confirm new map",classes:"rg2-confirm-add-map-dialog",doText:"Add map"}).onDo=this.doUploadMapFile.bind(this),e.onCancel=rg2.managerUI.doCancelAddMap.bind(this),rg2.utils.createModalDialog(e)},doUploadMapFile:function(){var e,t,s,r;$("#add-map-dialog").dialog("destroy"),e=rg2Config.json_url+"?type=uploadmapfile",t=this.user.encodeUser(),s=this,(r=new FormData).append(this.mapFile.name,this.mapFile),r.append("name",this.mapFile.name),r.append("x",t.x),r.append("y",t.y),$("#rg2-load-progress-label").text("Saving map"),$("#rg2-load-progress").show(),$.ajax({url:e,data:r,type:"POST",mimeType:"multipart/form-data",processData:!1,contentType:!1,dataType:"json",success:function(e){s.user.y=e.keksi,e.ok?s.doAddMap():rg2.utils.showWarningDialog("Save failed",e.status_msg+". Failed to save map. Please try again.")},error:function(e,t){console.log(t)},complete:function(){$("#rg2-load-progress-label").text(""),$("#rg2-load-progress").hide()}})},doAddMap:function(){var e,t,s,r,o;e=rg2Config.json_url+"?type=addmap",t={},this.newMap.localworldfile=this.localworldfile,t=this.newMap,s=this.user.encodeUser(),t.x=s.x,t.y=s.y,r=JSON.stringify(t),o=this,$.ajax({data:r,type:"POST",url:e,dataType:"json",success:function(e){o.user.y=e.keksi,e.ok?(rg2.utils.showWarningDialog("Map added",o.newMap.name+" has been added with id "+e.newid+"."),o.getMaps()):rg2.utils.showWarningDialog("Save failed",e.status_msg+". Failed to save map. Please try again.")},error:function(e,t){console.log(t)}})},readGeorefFile:function(e){var t,s;t=new FileReader,s=this;try{t.readAsText(e.target.files[0])}catch(e){return void rg2.utils.showWarningDialog("File read error","Failed to open selected world file.")}t.onerror=function(){rg2.utils.showWarningDialog("World file error","The selected world file could not be read.")},t.onload=function(e){var t;t=e.target.result.split(/[\r\n]+/g),delete s.localworldfile,s.localworldfile=new rg2.Worldfile({A:t[0],B:t[2],C:t[4],D:t[1],E:t[3],F:t[5]}),$("#rg2-georef-selected").val(s.georefsystems.getDefault()),s.convertWorldFile(s.georefsystems.getDefault())}},convertWorldFile:function(e){try{var t,s,r,o,n,i,a,l,g,c,u;if(s=rg2.getMapSize(),this.mapWidth=s.width,this.mapHeight=s.height,!this.localworldfile.valid||0===this.mapWidth||"none"===e)throw"Do not georeference";for(Proj4js.defs[e]=this.georefsystems.getParams(e),r=new Proj4js.Proj(e),o=new Proj4js.Proj("EPSG:4326"),a=[0,this.mapWidth,this.mapWidth,0],l=[0,this.mapHeight,0,this.mapHeight],n=[],i=[],t=0;t<4;t+=1)n[t]=this.localworldfile.getLon(a[t],l[t]),i[t]=this.localworldfile.getLat(a[t],l[t]);for(this.newMap.xpx.length=0,this.newMap.ypx.length=0,this.newMap.lat.length=0,this.newMap.lon.length=0,g=[],t=0;t<4;t+=1)(c={}).x=n[t],c.y=i[t],g.push(c),Proj4js.transform(r,o,g[t]),this.newMap.xpx.push(a[t]),this.newMap.ypx.push(l[t]),this.newMap.lat.push(g[t].y),this.newMap.lon.push(g[t].x);(u={}).C=g[0].x,u.F=g[0].y,u.A=(g[2].x-u.C)/a[2],u.B=(g[3].x-u.C)/l[3],u.D=(g[2].y-u.F)/a[2],u.E=(g[3].y-u.F)/l[3],delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(u),this.updateGeorefDisplay(),this.updateGeorefMap()}catch(e){return delete this.newMap.worldfile,this.newMap.worldfile=new rg2.Worldfile(0),this.updateGeorefDisplay(),void this.updateGeorefMap()}},updateGeorefDisplay:function(){var e,t;for(e=["A","B","C","D","E","F"],t=0;t<e.length;t+=1)$("#georef-"+e[t]).empty().text(e[t]+": "+this.newMap.worldfile[e[t]])},updateGeorefMap:function(){var t,s,e,r;t=this.newMap.lon,s=this.newMap.lat,r=[],[3,1,2,0].forEach(function(e){r.push([s[e],t[e]])}),(e=L.polygon(r,{color:"red"})).addTo(this.georefmap),$("#rg2-world-file-map").show(),this.georefmap.invalidateSize(),this.georefmap.fitBounds(e.getBounds())}},rg2.Manager=e}(),function(){function e(e,t,s){return this.courses=[],this.courseClassMapping=[],this.newcontrols=new rg2.Controls,this.courses.length=0,this.courseClassMapping.length=0,this.fromCondes=!1,this.coursesGeoreferenced=!1,this.newcontrols.deleteAllControls(),this.localWorldfile=s,this.worldfile=t,this.processCoursesXML(e.target.result),{courses:this.courses,newcontrols:this.newcontrols,mapping:this.courseClassMapping,georeferenced:this.coursesGeoreferenced}}e.prototype={Constructor:e,processCoursesXML:function(e){var t,s;try{t=$.parseXML(e)}catch(e){return void rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file.")}if(0!==t.getElementsByTagName("CourseData").length)switch(s=this.getVersion(t)){case"2.0.3":this.processIOFV2XMLCourses(t);break;case"3.0":this.processIOFV3XMLCourses(t);break;default:rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+s+" not supported.")}else rg2.utils.showWarningDialog("XML file error","File is not a valid XML course file. CourseData element missing.")},getVersion:function(e){var t,s;return s="",0<(t=e.getElementsByTagName("IOFVersion")).length&&(s=t[0].getAttribute("version")),""!==s||0<(t=e.getElementsByTagName("CourseData")).length&&(s=t[0].getAttribute("iofVersion").trim(),this.setCreator(t[0].getAttribute("creator").trim())),s},setCreator:function(e){-1<e.indexOf("Condes")&&(this.fromCondes=!0)},processIOFV3XMLCourses:function(e){var t,s,r,o,n;for(t=e.getElementsByTagName("Control"),o={x:0,y:0},s=0;s<t.length;s+=1)"RaceCourseData"===t[s].parentNode.nodeName&&(r=t[s].getElementsByTagName("Id")[0].textContent,n=t[s].getElementsByTagName("Position"),this.localWorldfile.valid&&0<n.length?(o=this.getXYFromLatLng(n),this.coursesGeoreferenced=!0):o=this.getXYFromMapPosition(t[s].getElementsByTagName("MapPosition")),"CrossingPoint"!==t[s].getAttribute("type")&&this.newcontrols.addControl(r.trim(),o.x,o.y));t=e.getElementsByTagName("Course"),this.extractV3Courses(t),t=e.getElementsByTagName("ClassCourseAssignment"),this.extractV3CourseClassMapping(t)},getXYFromLatLng:function(e){var t,s,r;return r={x:0,y:0},t=parseFloat(e[0].getAttribute("lat")),s=parseFloat(e[0].getAttribute("lng")),this.fromCondes?(r.x=this.localWorldfile.getX(s,t),r.y=this.localWorldfile.getY(s,t)):(r.x=this.worldfile.getX(s,t),r.y=this.worldfile.getY(s,t)),r},processIOFV2XMLCourses:function(e){var t,s,r;if(this.extractV2Controls(e.getElementsByTagName("StartPoint"),"StartPointCode"),this.extractV2Controls(e.getElementsByTagName("Control"),"ControlCode"),this.coursesGeoreferenced=this.extractV2Controls(e.getElementsByTagName("FinishPoint"),"FinishPointCode"),this.coursesGeoreferenced&&this.localWorldfile.valid)for(t=0;t<this.newcontrols.controls.length;t+=1)s=this.newcontrols.controls[t].x,r=this.newcontrols.controls[t].y,this.newcontrols.controls[t].x=this.localWorldfile.getX(s,r),this.newcontrols.controls[t].y=this.localWorldfile.getY(s,r);this.extractV2Courses(e.getElementsByTagName("Course"))},extractV2Courses:function(e){var t,s,r,o,n;for(t=0;t<e.length;t+=1)r=[],o=[],n=[],s=e[t].getElementsByTagName("CourseName")[0].textContent.trim(),(r=this.extractCodesFromControlList(e[t],"ControlCode")).unshift(e[t].getElementsByTagName("StartPointCode")[0].textContent.trim()),r.push(e[t].getElementsByTagName("FinishPointCode")[0].textContent.trim()),this.courses.push({courseid:0,x:o,y:n,codes:r,name:s});$("#rg2-select-course-file").addClass("valid")},extractV3Courses:function(e){var t,s,r,o,n;for(t=0;t<e.length;t+=1)[],o=[],n=[],s=e[t].getElementsByTagName("Name")[0].textContent.trim(),r=this.extractCodesFromControlList(e[t],"Control"),this.courses.push({courseid:0,x:o,y:n,codes:r,name:s});$("#rg2-select-course-file").addClass("valid")},extractV3CourseClassMapping:function(e){var t,s,r;for(t=0;t<e.length;t+=1)s=e[t].getElementsByTagName("CourseName")[0].textContent.trim(),r=e[t].getElementsByTagName("ClassName")[0].textContent.trim(),this.courseClassMapping.push({course:s,className:r});$("#rg2-select-course-file").addClass("valid")},extractCodesFromControlList:function(e,t){var s,r,o,n;for(n=e.getElementsByTagName("CourseControl"),o=[],s=0;s<n.length;s+=1)r=n[s].getElementsByTagName(t)[0].textContent.trim(),this.validControlCode(r)&&o.push(r);return o},extractV2Controls:function(e,t){var s,r,o,n,i;for(i=!1,r={x:0,y:0},s=0;s<e.length;s+=1)o=e[s].getElementsByTagName(t)[0].textContent,0<(n=e[s].getElementsByTagName("ControlPosition")).length&&this.localWorldfile.valid?(r.x=parseFloat(n[0].getAttribute("x")),r.y=parseFloat(n[0].getAttribute("y")),i=!0):r=this.getXYFromMapPosition(e[s].getElementsByTagName("MapPosition")),this.newcontrols.addControl(o.trim(),r.x,r.y);return i},getXYFromMapPosition:function(e){return{x:e[0].getAttribute("x").replace(",","."),y:e[0].getAttribute("y").replace(",",".")}},validControlCode:function(e){var t,s;for(s=this.newcontrols.controls,t=0;t<s.length;t+=1)if(s[t].code===e)return!0;return!1}},rg2.CourseParser=e}(),function(){function e(e){return this.results=[],this.valid=!0,this.processIOFV2Results(e),{results:this.results,valid:this.valid}}e.prototype={Constructor:e,getDBID:function(e,t){return 0===e.length?t:(e=e[0].textContent.replace(/[\n\r]/g,"").trim())||t},getName:function(e){return(e.getElementsByTagName("Given")[0].textContent+" "+e.getElementsByTagName("Family")[0].textContent).replace(/[\n\r]/g,"").trim()},processIOFV2Results:function(e){var t,s,r,o,n,i,a;try{for(t=e.getElementsByTagName("ClassResult"),o=0;o<t.length;o+=1)for(a=t[o].getElementsByTagName("ClassShortName")[0].textContent,s=t[o].getElementsByTagName("PersonResult"),n=0;n<s.length;n+=1)(i={}).course=a,i.name=this.getName(s[n]),i.dbid=this.getDBID(s[n].getElementsByTagName("PersonId"),n),i.club=rg2.utils.extractTextContentZero(s[n].getElementsByTagName("ShortName"),""),r=s[n].getElementsByTagName("Result"),this.extractIOFV2Results(r,i),"DidNotStart"!==i.status&&this.results.push(i)}catch(e){return this.valid=!1,void rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+e.message)}},getStartFinishTimeAsSecs:function(e){var t;return 0<e.length?(t=e[0].getElementsByTagName("Clock")[0].textContent,rg2.utils.getSecsFromHHMMSS(t)):0},getPosition:function(e){return 0<e.length?parseInt(e[0].textContent,10):""},getTime:function(e){return 0<e.length?e[0].textContent.replace(/[\n\r]/g,""):""},extractIOFV2Results:function(e,t){var s,r,o;for(s=0;s<e.length;s+=1)t.status=rg2.utils.extractAttributeZero(e[s].getElementsByTagName("CompetitorStatus"),"value",""),t.position=this.getPosition(e[s].getElementsByTagName("ResultPosition")),t.chipid=rg2.utils.extractTextContentZero(e[s].getElementsByTagName("CCardId"),0),t.time=this.getTime(e[s].getElementsByTagName("Time")),t.starttime=this.getStartFinishTimeAsSecs(e[s].getElementsByTagName("StartTime")),t.splits="",t.codes=[],o=e[s].getElementsByTagName("SplitTime"),t.controls=o.length,this.extractIOFV2Splits(o,t),r=this.getStartFinishTimeAsSecs(e[s].getElementsByTagName("FinishTime")),t.splits+=Math.max(r-t.starttime,0)},extractIOFV2Splits:function(e,t){var s,r;for(s=0;s<e.length;s+=1)0<s&&(t.splits+=";"),0<(r=e[s].getElementsByTagName("Time")).length?(t.splits+=rg2.utils.getSecsFromHHMMSS(r[0].textContent),t.codes[s]=rg2.utils.extractTextContentZero(e[s].getElementsByTagName("ControlCode"),"")):(t.splits+=0,t.codes[s]="");t.splits+=";"}},rg2.ResultParserIOFV2=e}(),function(){function e(e){return this.results=[],this.valid=!0,this.processIOFV3Results(e),{results:this.results,valid:this.valid}}e.prototype={Constructor:e,getID:function(e,t){var s;return 0<e.length?((s=e[0].textContent).replace(/[\n\r]/g,""),s.trim()):t},getClub:function(e){return 0<e.length&&e[0].getElementsByTagName("Name")[0]?e[0].getElementsByTagName("Name")[0].textContent:""},processIOFV3Results:function(e){var t,s,r,o,n,i,a,l;try{for(t=e.getElementsByTagName("ClassResult"),o=0;o<t.length;o+=1)for(a=(l=t[o].getElementsByTagName("Class"))[0].getElementsByTagName("Name")[0].textContent,s=t[o].getElementsByTagName("PersonResult"),n=0;n<s.length;n+=1)(i={}).course=a,l=s[n].getElementsByTagName("Given")[0].textContent+" "+s[n].getElementsByTagName("Family")[0].textContent,i.name=l.replace(/[\n\r]/g,"").trim(),i.dbid=this.getID(s[n].getElementsByTagName("Id"),n),i.club=this.getClub(s[n].getElementsByTagName("Organisation")),r=s[n].getElementsByTagName("Result"),this.extractIOFV3Results(r,i),"DidNotStart"!==i.status&&this.results.push(i)}catch(e){return this.valid=!1,void rg2.utils.showWarningDialog("XML parse error","Error processing XML file. Error is : "+e.message)}},getStartFinishTimeAsSeconds:function(e){return 19<=e.length?rg2.utils.getSecsFromHHMMSS(e.substr(11,8)):0},getTotalTimeAsSeconds:function(e){if(0<e.length&&e[0].textContent){var t=parseInt(e[0].textContent,10);return rg2.utils.formatSecsAsMMSS(t)}return"00:00"},extractIOFV3Results:function(e,t){var s,r,o;for(s=0;s<e.length;s+=1)t.chipid=rg2.utils.extractTextContentZero(e[s].getElementsByTagName("ControlCard"),0),t.position=rg2.utils.extractTextContentZero(e[s].getElementsByTagName("Position"),""),"0"===t.position&&(t.position=""),t.status=rg2.utils.extractTextContentZero(e[s].getElementsByTagName("Status"),""),t.time=this.getTotalTimeAsSeconds(e[s].getElementsByTagName("Time")),t.starttime=this.getStartFinishTimeAsSeconds(rg2.utils.extractTextContentZero(e[s].getElementsByTagName("StartTime"),0)),t.splits="",t.codes=[],o=e[s].getElementsByTagName("SplitTime"),this.extractIOFV3Splits(o,t),r=this.getStartFinishTimeAsSeconds(rg2.utils.extractTextContentZero(e[s].getElementsByTagName("FinishTime"),0)),t.splits+=0<r?r-t.starttime:0},extractIOFV3Splits:function(e,t){var s,r;for(r=[],s=0;s<e.length;s+=1)0===e[s].attributes.length&&(t.splits+=rg2.utils.extractTextContentZero(e[s].getElementsByTagName("Time"),0),r.push(rg2.utils.extractTextContentZero(e[s].getElementsByTagName("ControlCode"),"X"+s)),t.splits+=";");t.codes=r,t.controls=t.codes.length}},rg2.ResultParserIOFV3=e}(),function(){function e(e){return this.results=[],this.CSVFormat={},this.separator="",this.valid=!0,this.processResultsCSV(e),{results:this.results,valid:this.valid}}e.prototype={Constructor:e,processResultsCSV:function(e){var t,s,r;s=(t=e.split(/[\r\n|\n]+/))[0].split(",").length-1,r=t[0].split(";").length-1,this.separator=r<s?",":";",2===t[0].split(this.separator).length?this.processSpklasseCSVResults(t):(this.getCSVFormat(t[0]),this.processCSVResults(t))},processCSVResults:function(e){var t,s,r;for(t=1;t<e.length;t+=1)(s=e[t].split(this.separator)).length>=this.CSVFormat.FIRST_SPLIT_IDX&&(r=this.extractSingleCSVResult(s)).valid&&(delete r.valid,this.results.push(r))},getPosition:function(e){var t;return t=parseInt(e[this.CSVFormat.POSITION_IDX],10),isNaN(t)&&(t=""),t},extractSingleCSVResult:function(e){var t,s;return(t={valid:!0}).chipid=e[this.CSVFormat.CHIP_IDX],t.name=(e[this.CSVFormat.FIRST_NAME_IDX]+" "+e[this.CSVFormat.SURNAME_IDX]).trim().replace(/\"/g,""),t.dbid=e[this.CSVFormat.DB_IDX],t.starttime=rg2.utils.getSecsFromHHMMSS(e[this.CSVFormat.START_TIME_IDX]),t.time=e[this.CSVFormat.TOTAL_TIME_IDX],t.position=this.getPosition(e),t.status=this.getSICSVStatus(e[this.CSVFormat.NC_IDX],e[this.CSVFormat.CLASSIFIER_IDX]),t.club=e[this.CSVFormat.CLUB_IDX].trim().replace(/\"/g,""),t.course=e[this.CSVFormat.COURSE_IDX],""===t.course&&(t.valid=!1),t.controls=parseInt(e[this.CSVFormat.NUM_CONTROLS_IDX],10),s=this.extractSISplits(e,t.controls),t.splits=s.splits,""!==t.splits&&(t.splits+=";"),t.splits+=rg2.utils.getSecsFromHHMMSS(t.time),t.codes=s.codes,t},extractSISplits:function(e,t){var s,r,o,n;for(n=this.CSVFormat.FIRST_SPLIT_IDX,o=this.CSVFormat.FIRST_CODE_IDX,r={splits:"",codes:[]},s=0;s<t;s+=1)e[o]&&(0<s&&(r.splits+=";"),r.codes[s]=e[o],r.splits+=rg2.utils.getSecsFromHHMMSS(e[n])),n+=this.CSVFormat.STEP,o+=this.CSVFormat.STEP;return{splits:r.splits,codes:r.codes}},getCSVFormat:function(e){var t,s,r,o,n,i;for(t=["SI card","Database Id","Surname","First name","nc","Start","Time","Classifier","City","Short","Course","Course controls","Pl","Start punch","Control1","Punch1","Control2"],s=[],r=e.split(this.separator),o=0;o<t.length;o+=1){for(i=!1,n=0;n<r.length;n+=1){if(r[n]===t[o]){s[o]=n,i=!0;break}if("SI card"===t[o]&&("Chipno"===r[n]||"SIcard"===r[n]||"Database Id"===r[n])){s[o]=n,i=!0;break}if("nc"===t[o]&&"Classifier"===r[n]){s[o]=n,i=!0;break}if("City"===t[o]&&"Club"===r[n]){s[o]=n,i=!0;break}if("Pl"===t[o]&&"Place"===r[n]){s[o]=n,i=!0;break}}if(!i)break}i||(s=[1,2,3,4,8,9,11,12,15,18,39,42,43,44,46,47,2]),this.setCSVFormat(s)},setCSVFormat:function(e){this.CSVFormat.CHIP_IDX=e[0],this.CSVFormat.DB_IDX=e[1],this.CSVFormat.SURNAME_IDX=e[2],this.CSVFormat.FIRST_NAME_IDX=e[3],this.CSVFormat.NC_IDX=e[4],this.CSVFormat.START_TIME_IDX=e[5],this.CSVFormat.TOTAL_TIME_IDX=e[6],this.CSVFormat.CLASSIFIER_IDX=e[7],this.CSVFormat.CLUB_IDX=e[8],this.CSVFormat.CLASS_IDX=e[9],this.CSVFormat.COURSE_IDX=e[10],this.CSVFormat.NUM_CONTROLS_IDX=e[11],this.CSVFormat.POSITION_IDX=e[12],this.CSVFormat.START_PUNCH_IDX=e[13],this.CSVFormat.FIRST_CODE_IDX=e[14],this.CSVFormat.FIRST_SPLIT_IDX=e[15],this.CSVFormat.STEP=e[16]-e[14]},getSICSVStatus:function(e,t){return"0"===e||""===e||"N"===e?""===t||"0"===t?"ok":"nok":"nc"},processSpklasseCSVResults:function(e){var t,s,r,o;for(o=[],t="",r=s=0;r<e.length;r+=1)2===(o=e[r].split(this.separator)).length?(t=o[0],s=parseInt(o[1],10)):this.extractResult(o,t,s)},extractResult:function(e,t,s){var r,o;(r={chipid:0}).name=(e[0]+" "+e[1]+" "+e[2]).trim(),r.dbid=r.chipid+"__"+r.name,r.starttime=rg2.utils.getSecsFromHHMM(e[3]),r.club=e[2],r.course=t,r.controls=s,o=this.extractSpklasseSplits(e),r.splits=o.splits,r.codes=o.codes,r.time=rg2.utils.formatSecsAsMMSS(o.totaltime),this.results.push(r)},extractSpklasseSplits:function(e){var t,s,r,o,n;for(s="",r=[],n=e.length-4,t=o=0;t<n;t+=1)0<t&&(s+=";"),r[t]="X",s+=o+=rg2.utils.getSecsFromHHMMSS(e[t+4]);return{splits:s,codes:r,totaltime:o}}},rg2.ResultParserCSV=e}(),function(){function e(e,t){var s;return this.results=[],this.resultCourses=[],this.valid=!0,s=this.processResults(e,t),this.results=s.results,this.valid=s.valid,this.getCoursesFromResults(),{results:this.results,resultCourses:this.resultCourses,valid:this.valid}}e.prototype={Constructor:e,processResults:function(e,t){switch(t){case"CSV":return new rg2.ResultParserCSV(e.target.result);case"XML":return this.processResultsXML(e.target.result);default:return rg2.utils.showWarningDialog("File type error","Results file type is not recognised. Please select a valid file."),{results:[],valid:!1}}},getCoursesFromResults:function(){var e,t,s;for(e=0;e<this.results.length;e+=1){for(s=!1,t=0;t<this.resultCourses.length;t+=1)if(this.resultCourses[t].course===this.results[e].course){s=!0;break}s||this.resultCourses.push({course:this.results[e].course,courseid:rg2.config.DO_NOT_SAVE_COURSE})}},processResultsXML:function(e){var t,s;s="";try{if(0===(t=$.parseXML(e)).getElementsByTagName("ResultList").length)return rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file. ResultList element missing."),{results:[],valid:!1};""===(s=rg2.utils.extractAttributeZero(t.getElementsByTagName("IOFVersion"),"version",""))&&(s=rg2.utils.extractAttributeZero(t.getElementsByTagName("ResultList"),"iofVersion",""))}catch(e){return rg2.utils.showWarningDialog("XML file error","File is not a valid XML results file."),{results:[],valid:!1}}switch(s){case"2.0.3":return new rg2.ResultParserIOFV2(t);case"3.0":return new rg2.ResultParserIOFV3(t);default:return rg2.utils.showWarningDialog("XML file error","Invalid IOF file format. Version "+s+" not supported."),{results:[],valid:!1}}}},rg2.ResultParser=e}(),function(){var e={showItems:function(e,t){var s;for(s=0;s<e.length;s+=1)t?$(e[s]).show():$(e[s]).hide()},initialiseUI:function(){var e;e=["#rg2-animation-controls","#rg2-create-tab","#rg2-edit-tab","#rg2-map-tab","#rg2-draw-tab","#rg2-results-tab","#rg2-courses-tab","#rg2-events-tab"],this.showItems(e,!1),$("#rg2-manage-login").show(),$("#rg2-info-panel").tabs("disable",rg2.config.TAB_EVENTS).tabs("option","active",rg2.config.TAB_LOGIN)},setUIVisibility:function(){var e;e=["#rg2-draw-courses","#rg2-manage-login","#rg2-login-tab"],this.showItems(e,!1),e=["#rg2-manage-create","#rg2-create-tab","#rg2-edit-tab","#rg2-map-tab"],this.showItems(e,!0),$("#rg2-event-date-edit").datepicker({dateFormat:"yy-mm-dd"}),$("#rg2-event-comments").focus(function(){$("#rg2-event-comments").val()===rg2.config.DEFAULT_EVENT_COMMENT&&$("#rg2-event-comments").val("")})},displayCourseInfo:function(e){this.displayInfoDialog(e,"Course")},displayResultInfo:function(e){this.displayInfoDialog(e,"Result")},displayInfoDialog:function(e,t){e&&($("#rg2-manage-"+t.toLowerCase()+"s").empty().html(e),$("#rg2-manage-"+t.toLowerCase()+"s").dialog({title:t+" details",dialogClass:"rg2-"+t.toLowerCase()+"-info-dialog",resizable:!0,width:"auto",maxHeight:.9*window.innerHeight,buttons:{Ok:function(){$(this).dialog("close")}}}))},createMapDropdown:function(e){var t,s;for($("#rg2-map-selected").empty(),(t=document.getElementById("rg2-map-selected")).options.add(rg2.utils.generateOption(rg2.config.INVALID_MAP_ID,"Select map")),s=e.length-1;-1<s;s-=1)t.options.add(rg2.utils.generateOption(s,e[s].mapid+": "+rg2.he.decode(e[s].name)))},createGeorefDropdown:function(e){var t;$("#rg2-georef-selected").empty(),t=document.getElementById("rg2-georef-selected"),t=e.getDropdown(t)},createEventEditDropdown:function(){var e;$("#rg2-event-selected").empty(),e=document.getElementById("rg2-event-selected"),e=rg2.events.getEventEditDropdown(e)},createRouteDeleteDropdown:function(e){var t,s,r;for($("#rg2-route-selected").empty(),t=document.getElementById("rg2-route-selected"),s=rg2.results.getRoutesForEvent(e),r=0;r<s.length;r+=1)t.options.add(rg2.utils.generateOption(s[r].resultid,s[r].resultid+": "+rg2.he.decode(s[r].name)+" on "+rg2.he.decode(s[r].coursename)))},createEventLevelDropdown:function(e){var t,s,r,o;for($("#"+e).empty(),t=document.getElementById(e),s=["Select level","Training","Local","Regional","National","International"],r=["X","T","L","R","N","I"],o=0;o<s.length;o+=1)t.options.add(rg2.utils.generateOption(r[o],s[o]))},setEvent:function(e){var t;e?(t=rg2.events.getEventInfo(e),rg2.loadEvent(t.id)):(rg2.utils.setButtonState("disable",["#btn-delete-event","#btn-update-event","#btn-delete-route"]),$("#rg2-event-name-edit").val(""),$("#rg2-club-name-edit").val(""),$("#rg2-event-date-edit").val(""),$("#rg2-event-level-edit").val(""),$("#rg2-edit-event-comments").val(""),$("#rg2-route-selected").empty(),$("#chk-edit-read-only").prop("checked",!1))},eventFinishedLoading:function(e){$("#rg2-event-name-edit").empty().val(rg2.he.decode(e.name)),$("#rg2-club-name-edit").empty().val(rg2.he.decode(e.club)),$("#rg2-event-date-edit").empty().val(e.date),$("#rg2-event-level-edit").val(e.rawtype),$("#rg2-edit-event-comments").empty().val(rg2.he.decode(e.comment)),$("#chk-edit-read-only").prop("checked",e.locked),rg2.utils.setButtonState("enable",["#btn-delete-event","#btn-update-event","#btn-delete-route"]),this.createRouteDeleteDropdown(e.id)},doCancelDeleteEvent:function(){$("#event-delete-dialog").dialog("destroy")},doCancelDeleteRoute:function(){$("#route-delete-dialog").dialog("destroy")},doCancelUpdateEvent:function(){$("#event-update-dialog").dialog("destroy")},doCancelCreateEvent:function(){$("#event-create-dialog").dialog("destroy")},doCancelAddMap:function(){$("#add-map-dialog").dialog("destroy")}};rg2.managerUI=e}();
//# sourceMappingURL=rg2manager-1.5.5.min.js.map
>>>>>>> refs/remotes/Maprunner/master:js/rg2manager-1.5.5.min.js
